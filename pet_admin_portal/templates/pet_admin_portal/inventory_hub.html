{% extends 'pet_admin_portal/base.html' %}
{% block title %}Clinic Inventory | EMR Hub{% endblock %}
{% block content %}
<section class="inventory-dashboard" id="inventory-dashboard">
  <div class="page-header">
    <div>
      <h1 class="page-title">Clinic Inventory Dashboard</h1>
      <p class="page-subtitle">Monitor stock health, log movement quickly, and keep pharmacy operations running smoothly.</p>
    </div>
  </div>

  <section class="grid three-col inventory-charts">
    <article class="card">
      <div class="card-head"><h3>Stock Levels</h3></div>
      <canvas class="inventory-chart" data-chart='{{ stock_levels_chart_json }}' data-kind="stock"></canvas>
    </article>
    <article class="card">
      <div class="card-head"><h3>Transaction Trend (10 days)</h3></div>
      <canvas class="inventory-chart" data-chart='{{ tx_trend_chart_json }}' data-kind="trend"></canvas>
    </article>
    <article class="card">
      <div class="card-head"><h3>Total Consumed Items</h3></div>
      <canvas class="inventory-chart" data-chart='{{ top_consumed_chart_json }}' data-kind="usage-consumed"></canvas>
    </article>
  </section>

  <section class="grid cards-5 inventory-kpis">
    <article class="stat-card"><h4>Total Items</h4><p>{{ total_items }}</p></article>
    <article class="stat-card"><h4>Low Stock</h4><p>{{ low_stock_count }}</p></article>
    <article class="stat-card"><h4>Out of Stock</h4><p>{{ out_of_stock_count }}</p></article>
    <article class="stat-card"><h4>Transactions Today</h4><p>{{ tx_today_count }}</p></article>
    <article class="stat-card"><h4>Recently Added</h4><p>{{ recent_items|length }}</p></article>
  </section>

  <section class="grid two-col inventory-actions" id="inventory-actions">
    <article class="card">
      <div class="card-head">
        <h3>Create Inventory Item</h3>
        <p>Add medicine, food, or consumable with thresholds for alerting.</p>
      </div>
      <form method="post" action="{% url 'pet_admin_portal:create_inventory_item' %}" class="form-grid inventory-form">
        {% csrf_token %}
        <input type="hidden" name="return_anchor" value="inventory-actions">
        <div class="form-row">{{ inventory_item_form.name.label_tag }}{{ inventory_item_form.name }}</div>
        <div class="form-row">{{ inventory_item_form.category.label_tag }}{{ inventory_item_form.category }}</div>
        <div class="form-row">{{ inventory_item_form.sku.label_tag }}{{ inventory_item_form.sku }}</div>
        <div class="form-row">{{ inventory_item_form.stock_quantity.label_tag }}{{ inventory_item_form.stock_quantity }}</div>
        <div class="form-row">{{ inventory_item_form.unit.label_tag }}{{ inventory_item_form.unit }}</div>
        <div class="form-row">{{ inventory_item_form.low_stock_threshold.label_tag }}{{ inventory_item_form.low_stock_threshold }}</div>
        <button class="btn-primary" type="submit">Create Item</button>
      </form>
    </article>

    <article class="card">
      <div class="card-head">
        <h3>Log Stock Movement</h3>
        <p>Use quick mode buttons for purchase, consumption, or adjustment.</p>
      </div>
      <form method="post" action="{% url 'pet_admin_portal:create_inventory_tx' %}" class="form-grid inventory-form" id="tx-form">
        {% csrf_token %}
        <input type="hidden" name="return_anchor" value="inventory-actions">
        <div class="segment-control" data-segment>
          <button type="button" class="seg-btn active" data-type="purchase">Purchase</button>
          <button type="button" class="seg-btn" data-type="consumption">Consumption</button>
          <button type="button" class="seg-btn" data-type="adjustment">Adjustment</button>
        </div>
        <div class="hidden-select">{{ inventory_tx_form.transaction_type }}</div>
        <div class="form-row">{{ inventory_tx_form.inventory_item.label_tag }}{{ inventory_tx_form.inventory_item }}</div>
        <div class="form-row">{{ inventory_tx_form.quantity.label_tag }}{{ inventory_tx_form.quantity }}</div>
        <div class="form-row">{{ inventory_tx_form.unit_cost.label_tag }}{{ inventory_tx_form.unit_cost }}</div>
        <div class="form-row">{{ inventory_tx_form.note.label_tag }}{{ inventory_tx_form.note }}</div>
        <button class="btn-primary" type="submit">Log Transaction</button>
      </form>
    </article>
  </section>

  <section class="card inventory-table-card" id="inventory-items">
    <div class="card-head card-head-split">
      <div>
        <h3>Inventory Items</h3>
        <p>Track stock and perform quick operational actions.</p>
      </div>
      <form method="get" action="{% url 'pet_admin_portal:clinic_inventory' %}#inventory-items" class="toolbar">
        <div class="search-wrap">
          <input name="q" value="{{ q }}" placeholder="Search item / SKU / category">
          <button type="submit">Search</button>
        </div>
        <input type="hidden" name="tx_type" value="{{ tx_type }}">
        <input type="hidden" name="tx_from" value="{{ tx_from }}">
        <input type="hidden" name="tx_to" value="{{ tx_to }}">
      </form>
    </div>
    <div class="table-wrap inventory-table-wrap">
      <table>
        <thead>
          <tr>
            <th><a href="?q={{ q|urlencode }}&sort=name&dir={% if sort == 'name' and direction == 'asc' %}desc{% else %}asc{% endif %}&tx_type={{ tx_type }}&tx_from={{ tx_from }}&tx_to={{ tx_to }}">Item</a></th>
            <th><a href="?q={{ q|urlencode }}&sort=category&dir={% if sort == 'category' and direction == 'asc' %}desc{% else %}asc{% endif %}&tx_type={{ tx_type }}&tx_from={{ tx_from }}&tx_to={{ tx_to }}">Category</a></th>
            <th>SKU</th>
            <th><a href="?q={{ q|urlencode }}&sort=stock&dir={% if sort == 'stock' and direction == 'asc' %}desc{% else %}asc{% endif %}&tx_type={{ tx_type }}&tx_from={{ tx_from }}&tx_to={{ tx_to }}">Stock</a></th>
            <th>Threshold</th>
            <th>Status</th>
            <th><a href="?q={{ q|urlencode }}&sort=updated&dir={% if sort == 'updated' and direction == 'asc' %}desc{% else %}asc{% endif %}&tx_type={{ tx_type }}&tx_from={{ tx_from }}&tx_to={{ tx_to }}">Updated</a></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in inventory_items %}
          <tr>
            <td><strong>{{ item.name }}</strong></td>
            <td><span class="inv-badge inv-cat-{{ item.category }}">{{ item.get_category_display }}</span></td>
            <td>{{ item.sku|default:"-" }}</td>
            <td>{{ item.stock_quantity }} {{ item.unit }}</td>
            <td>{{ item.low_stock_threshold }}</td>
            <td>
              {% if item.stock_quantity <= 0 %}
                <span class="inv-badge inv-out">Out of Stock</span>
              {% elif item.is_low_stock %}
                <span class="inv-badge inv-low">Low Stock</span>
              {% else %}
                <span class="inv-badge inv-ok">In Stock</span>
              {% endif %}
            </td>
            <td>{{ item.updated_at|date:'d M Y, h:i A' }}</td>
            <td>
              <details class="inv-actions-menu">
                <summary class="btn-link btn-mini">Actions</summary>
                <div class="inv-actions-popover">
                  <button type="button" class="inv-action-item js-quick-tx" data-type="purchase" data-item-id="{{ item.id }}">Add Stock</button>
                  <button type="button" class="inv-action-item js-quick-tx" data-type="consumption" data-item-id="{{ item.id }}">Deduct</button>
                  <button type="button" class="inv-action-item js-edit-item"
                    data-id="{{ item.id }}"
                    data-name="{{ item.name }}"
                    data-category="{{ item.category }}"
                    data-sku="{{ item.sku }}"
                    data-stock="{{ item.stock_quantity }}"
                    data-unit="{{ item.unit }}"
                    data-threshold="{{ item.low_stock_threshold }}"
                  >Edit</button>
                <form method="post" action="{% url 'pet_admin_portal:soft_delete_record' 'inventory_item' item.id %}" class="js-disable-form">
                  {% csrf_token %}
                  <input type="hidden" name="return_anchor" value="inventory-items">
                  <button type="submit" class="inv-action-item inv-action-danger">Disable</button>
                </form>
                </div>
              </details>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8">No inventory items found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="card" id="transaction-log">
    <div class="card-head card-head-split">
      <div>
        <h3>Transaction Log</h3>
        <p>Filter transaction history by type and date range.</p>
      </div>
      <form method="get" action="{% url 'pet_admin_portal:clinic_inventory' %}#transaction-log" class="toolbar inventory-filter-bar">
        <input type="hidden" name="q" value="{{ q }}">
        <select name="tx_type">
          <option value="">All Types</option>
          <option value="purchase" {% if tx_type == "purchase" %}selected{% endif %}>Purchase</option>
          <option value="consumption" {% if tx_type == "consumption" %}selected{% endif %}>Consumption</option>
          <option value="adjustment" {% if tx_type == "adjustment" %}selected{% endif %}>Adjustment</option>
        </select>
        <input type="date" name="tx_from" value="{{ tx_from }}">
        <input type="date" name="tx_to" value="{{ tx_to }}">
        <button class="btn-link" type="submit">Apply</button>
      </form>
    </div>
    <div class="table-wrap inventory-table-wrap">
      <table>
        <thead><tr><th>Date</th><th>Item</th><th>Type</th><th>Qty</th><th>By</th><th>Note</th></tr></thead>
        <tbody>
          {% for tx in inventory_transactions %}
          <tr>
            <td>{{ tx.created_at|date:'d M Y, h:i A' }}</td>
            <td>{{ tx.inventory_item.name }}</td>
            <td>
              {% if tx.transaction_type == "purchase" %}
                <span class="inv-badge tx-purchase">↗ Purchase</span>
              {% elif tx.transaction_type == "consumption" %}
                <span class="inv-badge tx-consumption">↘ Consumption</span>
              {% else %}
                <span class="inv-badge tx-adjustment">↔ Adjustment</span>
              {% endif %}
            </td>
            <td>{{ tx.quantity }}</td>
            <td>{{ tx.created_by|default:"System" }}</td>
            <td>{{ tx.note|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="6">No transactions found for selected filters.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</section>

<div id="inventory-edit-modal" class="modal" aria-hidden="true">
  <div class="modal-panel">
    <div class="modal-head"><h3>Edit Inventory Item</h3><button data-close-modal>&times;</button></div>
    <form method="post" id="inventory-edit-form" data-update-url-template="{% url 'pet_admin_portal:update_inventory_item' 0 %}" class="form-grid inventory-form">
      {% csrf_token %}
      <input type="hidden" name="return_anchor" value="inventory-items">
      <div class="form-row"><label>Name</label><input name="name" required></div>
      <div class="form-row"><label>Category</label>
        <select name="category">
          <option value="food">Food</option>
          <option value="medicine">Medicine</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-row"><label>SKU</label><input name="sku"></div>
      <div class="form-row"><label>Stock Quantity</label><input name="stock_quantity" type="number" step="0.01"></div>
      <div class="form-row"><label>Unit</label><input name="unit"></div>
      <div class="form-row"><label>Low Stock Threshold</label><input name="low_stock_threshold" type="number" step="0.01"></div>
      <button class="btn-primary" type="submit">Save Changes</button>
    </form>
  </div>
</div>

<div id="inventory-disable-modal" class="modal" aria-hidden="true">
  <div class="modal-panel modal-panel-sm">
    <div class="modal-head">
      <h3>Disable Inventory Item</h3>
      <button type="button" data-close-modal>&times;</button>
    </div>
    <div class="modal-body">
      <p class="confirm-copy">This item will be disabled and hidden from normal operations. You can restore it later if needed.</p>
      <div class="confirm-actions">
        <button type="button" class="btn-link" id="disable-cancel-btn">Cancel</button>
        <button type="button" class="btn-danger" id="disable-confirm-btn">Disable Item</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const txForm = document.getElementById('tx-form');
  if (txForm) {
    const txTypeSelect = txForm.querySelector('select[name="transaction_type"]');
    const segButtons = txForm.querySelectorAll('.seg-btn');
    const setType = (type) => {
      txTypeSelect.value = type;
      segButtons.forEach((btn) => btn.classList.toggle('active', btn.dataset.type === type));
    };
    setType(txTypeSelect.value || 'purchase');
    segButtons.forEach((btn) => btn.addEventListener('click', () => setType(btn.dataset.type)));

    document.querySelectorAll('.js-quick-tx').forEach((btn) => {
      btn.addEventListener('click', () => {
        setType(btn.dataset.type);
        const itemField = txForm.querySelector('select[name="inventory_item"]');
        itemField.value = btn.dataset.itemId;
        txForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        txForm.querySelector('input[name="quantity"]').focus();
      });
    });
  }

  const modal = document.getElementById('inventory-edit-modal');
  const editForm = document.getElementById('inventory-edit-form');
  document.querySelectorAll('.js-edit-item').forEach((btn) => {
    btn.addEventListener('click', () => {
      const tmpl = editForm.dataset.updateUrlTemplate;
      editForm.action = tmpl.replace('/0/', `/${btn.dataset.id}/`);
      editForm.querySelector('[name="name"]').value = btn.dataset.name || '';
      editForm.querySelector('[name="category"]').value = btn.dataset.category || 'other';
      editForm.querySelector('[name="sku"]').value = btn.dataset.sku || '';
      editForm.querySelector('[name="stock_quantity"]').value = btn.dataset.stock || 0;
      editForm.querySelector('[name="unit"]').value = btn.dataset.unit || 'units';
      editForm.querySelector('[name="low_stock_threshold"]').value = btn.dataset.threshold || 0;
      modal.classList.add('open');
      const y = window.scrollY || window.pageYOffset || 0;
      document.body.dataset.modalLockY = String(y);
      document.body.style.top = `-${y}px`;
      document.body.classList.add('modal-open', 'modal-open-lock');
    });
  });

  const parse = (raw) => { try { return JSON.parse(raw); } catch (e) { return null; } };
  const pieColors = ['#1570c0','#2a8a5b','#f0b65a','#8b75da','#f17b7b','#6fb7d6','#9dc66e','#b4b4c8'];
  const noDataPayload = () => ({ labels: ['No data'], values: [1], empty: true });
  document.querySelectorAll('.inventory-chart').forEach((canvas) => {
    const payload = parse(canvas.dataset.chart);
    if (!payload) return;
    const kind = canvas.dataset.kind;
    const common = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: kind === 'trend' } },
      scales: { y: { beginAtZero: true } }
    };
    if (kind === 'stock') {
      new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: payload.labels || [],
          datasets: [{ label: 'Stock', data: payload.values || [], backgroundColor: '#1570c0' }]
        },
        options: common
      });
    } else if (kind === 'trend') {
      new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: payload.labels || [],
          datasets: [
            { label: 'Purchase', data: payload.purchases || [], borderColor: '#1a7a4a', backgroundColor: 'rgba(26,122,74,.15)', fill: true, tension: 0.3 },
            { label: 'Consumption', data: payload.consumption || [], borderColor: '#b53333', backgroundColor: 'rgba(181,51,51,.12)', fill: true, tension: 0.3 },
            { label: 'Adjustment', data: payload.adjustments || [], borderColor: '#0b5394', backgroundColor: 'rgba(11,83,148,.12)', fill: true, tension: 0.3 }
          ]
        },
        options: common
      });
    } else if (kind === 'usage-consumed') {
      const hasValues = Array.isArray(payload.values) && payload.values.some((v) => Number(v) > 0);
      const safe = hasValues ? payload : noDataPayload();
      new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: safe.labels || [],
          datasets: [{ data: safe.values || [], backgroundColor: safe.empty ? ['#cfd8e3'] : pieColors }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' }, tooltip: { enabled: !safe.empty } }
        }
      });
    }
  });

  const disableModal = document.getElementById('inventory-disable-modal');
  const disableCancelBtn = document.getElementById('disable-cancel-btn');
  const disableConfirmBtn = document.getElementById('disable-confirm-btn');
  let pendingDisableForm = null;
  const actionMenus = Array.from(document.querySelectorAll('.inv-actions-menu'));

  const closeAllActionMenus = () => {
    actionMenus.forEach((menu) => { menu.open = false; });
  };

  const closeDisableModal = () => {
    pendingDisableForm = null;
    disableModal.classList.remove('open');
    document.body.classList.remove('modal-open', 'modal-open-lock');
    document.body.style.top = '';
  };

  document.querySelectorAll('.js-disable-form').forEach((form) => {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      closeAllActionMenus();
      pendingDisableForm = form;
      const y = window.scrollY || window.pageYOffset || 0;
      document.body.style.top = `-${y}px`;
      document.body.classList.add('modal-open', 'modal-open-lock');
      disableModal.classList.add('open');
    });
  });

  if (disableCancelBtn) {
    disableCancelBtn.addEventListener('click', closeDisableModal);
  }
  if (disableConfirmBtn) {
    disableConfirmBtn.addEventListener('click', () => {
      if (pendingDisableForm) pendingDisableForm.submit();
    });
  }
  if (disableModal) {
    disableModal.addEventListener('click', (e) => {
      if (e.target === disableModal) closeDisableModal();
    });
  }

  document.addEventListener('click', (e) => {
    actionMenus.forEach((menu) => {
      if (!menu.contains(e.target)) {
        menu.open = false;
      }
    });
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAllActionMenus();
  });
})();
</script>
{% endblock %}
