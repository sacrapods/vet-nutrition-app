{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - NutriVet</title>
    <link rel="stylesheet" href="{% static 'design_system/tokens.css' %}">
    <style>
        /* shell-fallback: protects nav if static CSS fails */
        html, body { margin:0 !important; padding:0 !important; }
        .skip-link { position:fixed; left:12px; top:10px; transform:translateY(-180%); background:#0f1720; color:#fff; padding:8px 12px; border-radius:8px; z-index:9999; text-decoration:none; font-size:13px; font-weight:700; }
        .skip-link:focus { transform:translateY(0); }
        .app-shell { display:grid; grid-template-columns:244px 1fr; min-height:100dvh; margin:0 !important; }
        .app-sidebar { background:linear-gradient(180deg,#102b23,#173a30); color:#dce7e1; padding:18px 12px; position:sticky; top:0; height:100dvh; overflow:auto; box-shadow:inset -1px 0 0 rgba(255,255,255,.06); }
        .app-sidebar.app-sidebar--blue { background:linear-gradient(180deg,#173754,#2c5a8c); }
        .app-sidebar .brand { margin:0 0 14px; font-size:17px; font-weight:800; letter-spacing:-.01em; color:#dce7e1; }
        .app-sidebar nav a { display:block; color:#dce7e1; text-decoration:none; border:1px solid transparent; border-radius:10px; padding:9px 10px; font-size:13px; font-weight:700; margin-bottom:4px; }
        .app-sidebar nav a:hover,.app-sidebar nav a.active { background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.18); }
        .app-main { padding:18px 16px 30px; }
        @media (max-width:1080px){ .app-shell{grid-template-columns:1fr;} .app-sidebar{position:relative;height:auto;} .app-main{padding-top:12px;} }
        body { font-family: "Avenir Next", "Trebuchet MS", "Segoe UI", sans-serif; }
        .hero { border-radius:20px; padding:26px; background:linear-gradient(126deg,#18402f,#2d6a4f 54%,#4f866d); color:#fff; box-shadow:0 18px 30px rgba(21,55,41,.2); }
        .hero-top { display:flex; justify-content:space-between; gap:12px; align-items:start; }
        h1 { margin-top:6px; font-size:30px; letter-spacing:-.02em; }
        .sub { margin-top:8px; max-width:620px; color:rgba(255,255,255,.86); font-size:14px; }
        .actions { display:flex; flex-wrap:wrap; gap:8px; }
        .btn { text-decoration:none; border:1px solid rgba(255,255,255,.35); color:#fff; padding:10px 13px; border-radius:10px; font-size:13px; font-weight:700; background:rgba(255,255,255,.12); }
        .stats { margin-top:14px; display:grid; gap:10px; grid-template-columns:repeat(4,minmax(0,1fr)); }
        .stat { background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.22); border-radius:12px; padding:12px 14px; }
        .stat .label { font-size:11px; text-transform:uppercase; letter-spacing:.08em; opacity:.78; }
        .stat .value { margin-top:4px; font-size:24px; font-weight:800; letter-spacing:-.02em; }
        .panel { margin-top:16px; background:var(--ds-panel); border:1px solid var(--ds-line); border-radius:var(--ds-radius); box-shadow:0 8px 20px rgba(21,26,24,.04); }
        .panel-head { padding:14px; border-bottom:1px solid var(--ds-line); }
        .search { display:flex; gap:8px; width:100%; }
        .search input { flex:1; border:1px solid var(--ds-line); border-radius:10px; padding:10px 12px; font-size:14px; }
        .search button { border:none; border-radius:10px; padding:10px 14px; font-weight:700; background:var(--ds-brand); color:#fff; cursor:pointer; }
        .table-wrap { overflow:auto; }
        table { width:100%; border-collapse:collapse; min-width:860px; }
        th,td { padding:12px 14px; border-bottom:1px solid #edf1ef; text-align:left; font-size:14px; vertical-align:middle; }
        th { font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:#74837c; background:#f8fbf9; }
        .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-weight:700; color:#385a4e; }
        .owner { color:var(--ds-muted); font-size:13px; }
        .status { display:inline-block; padding:4px 9px; border-radius:999px; font-size:11px; font-weight:700; }
        .status-open { background:#f8ebe2; color:#a6582a; }
        .status-done { background:#e8f2ed; color:#2d6a4f; }
        .row-actions { display:flex; gap:6px; }
        .link-btn { text-decoration:none; border:1px solid var(--ds-line); background:#fff; color:#2f3b36; padding:6px 9px; border-radius:8px; font-size:12px; font-weight:700; }
        @media (max-width:720px){
          .hero{padding:18px 14px;border-radius:16px}
          h1{font-size:26px}
          .hero-top{flex-direction:column}
          .actions{width:100%}
          .actions .btn{width:100%;text-align:center}
          .search{flex-direction:column}
          .search input,.search button{width:100%}
          th,td{padding:10px 9px;font-size:13px}
        }
    </style>
</head>
<body>
<a class="skip-link" href="#main-content">Skip to main content</a>
<div class="app-shell">
  <aside class="app-sidebar" aria-label="Admin navigation">
    <div class="brand">NUTRIVET ADMIN</div>
    <nav>
      <a class="active" href="{% url 'case_list' %}">Case Dashboard</a>
      <a href="{% url 'vet_cases' %}">Vet Cases</a>
      <a href="{% url 'appointments:admin_dashboard' %}">Appointments Ops</a>
      <a href="{% url 'logout' %}">Logout</a>
    </nav>
  </aside>

  <main id="main-content" class="app-main">
    <section class="hero">
      <div class="hero-top">
        <div>
          <div style="font-size:12px;letter-spacing:.08em;text-transform:uppercase;opacity:.8;">Admin Workspace</div>
          <h1>Clinical Case Dashboard</h1>
          <p class="sub">Monitor incoming cases, open each pet profile quickly, and track vet form completion status from one screen.</p>
        </div>
        <div class="actions"><a class="btn" href="{% url 'appointments:admin_dashboard' %}">Appointments Ops</a></div>
      </div>
      <div class="stats">
        <div class="stat"><div class="label">Total Cases</div><div class="value">{{ stats.total_cases }}</div></div>
        <div class="stat"><div class="label">Total Pets</div><div class="value">{{ stats.total_pets }}</div></div>
        <div class="stat"><div class="label">New Today</div><div class="value">{{ stats.cases_today }}</div></div>
        <div class="stat"><div class="label">Open Vet Forms</div><div class="value">{{ stats.open_vet_forms }}</div></div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <form class="search" method="get" role="search">
          <input type="text" name="q" value="{{ q }}" placeholder="Search by case ID, owner, or pet name" aria-label="Search cases">
          <button type="submit">Search</button>
        </form>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Case ID</th><th>Pet</th><th>Owner</th><th>Submitted</th><th>Vet Status</th><th>Actions</th></tr></thead>
          <tbody>
            {% for parent in parents %}
            {% for pet in parent.pets.all %}
            <tr>
              <td class="mono">{{ parent.case_id }}</td>
              <td><strong>{{ pet.name }}</strong><div class="owner">{{ pet.breed }}</div></td>
              <td>{{ parent.name }}<div class="owner">{{ parent.email }}</div></td>
              <td>{{ parent.created_at|date:"d M Y" }}</td>
              <td>{% if pet.clinical_history %}<span class="status status-done">Completed</span>{% else %}<span class="status status-open">Pending</span>{% endif %}</td>
              <td>
                <div class="row-actions">
                  <a class="link-btn" href="{% url 'case_detail' pet.pk %}">Open</a>
                  <a class="link-btn" href="{% url 'case_pdf' pet.pk %}">Print</a>
                  <a class="link-btn" href="{% url 'pet_admin_portal:profile_hub' parent.id %}?pet={{ pet.id }}">EMR Hub</a>
                </div>
              </td>
            </tr>
            {% endfor %}
            {% empty %}
            <tr><td colspan="6"><div class="empty-state"><h3>No cases found</h3><p>{% if q %}No results for "{{ q }}".{% else %}No cases submitted yet.{% endif %}</p></div></td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>
</body>
</html>
