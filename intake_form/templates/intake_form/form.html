{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poshtik NutriVet - Diet History Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'design_system/tokens.css' %}">
    <style>
        /* shell-fallback: protects nav if static CSS fails */
        html, body { margin:0 !important; padding:0 !important; }
        .skip-link { position:fixed; left:12px; top:10px; transform:translateY(-180%); background:#0f1720; color:#fff; padding:8px 12px; border-radius:8px; z-index:9999; text-decoration:none; font-size:13px; font-weight:700; }
        .skip-link:focus { transform:translateY(0); }
        .app-shell { display:grid; grid-template-columns:244px 1fr; min-height:100dvh; margin:0 !important; }
        .app-sidebar { background:linear-gradient(180deg,#102b23,#173a30); color:#dce7e1; padding:18px 12px; position:sticky; top:0; height:100dvh; overflow:auto; box-shadow:inset -1px 0 0 rgba(255,255,255,.06); }
        .app-sidebar.app-sidebar--blue { background:linear-gradient(180deg,#173754,#2c5a8c); }
        .app-sidebar .brand { margin:0 0 14px; font-size:17px; font-weight:800; letter-spacing:-.01em; color:#dce7e1; }
        .app-sidebar nav a { display:block; color:#dce7e1; text-decoration:none; border:1px solid transparent; border-radius:10px; padding:9px 10px; font-size:13px; font-weight:700; margin-bottom:4px; }
        .app-sidebar nav a:hover,.app-sidebar nav a.active { background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.18); }
        .app-main { padding:18px 16px 30px; }
        @media (max-width:1080px){ .app-shell{grid-template-columns:1fr;} .app-sidebar{position:relative;height:auto;} .app-main{padding-top:12px;} }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #FAF7F2;
            color: #2C2C2C;
            line-height: 1.65;
        }

        .container {
            max-width: 920px;
            margin: 0 auto;
            padding: 24px 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #4A7A4F, #7A9E7E);
            padding: 34px 28px;
            text-align: center;
            border-radius: 12px 12px 0 0;
            color: white;
            box-shadow: 0 12px 24px rgba(41, 74, 55, 0.16);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .form-card {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 34px;
        }
        
        .section-title {
            font-size: 1.35rem;
            color: #4A7A4F;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #E8E4DE;
            letter-spacing: -0.01em;
        }
        
        .form-group {
            margin-bottom: 22px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2C2C2C;
            font-size: 0.92rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid #D9D4CC;
            border-radius: 8px;
            font-size: 0.92rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #7A9E7E;
            box-shadow: 0 0 0 3px rgba(122,158,126,0.15);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: both;
            overflow: auto;
        }
        
        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1.5px solid #D9D4CC;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .radio-group input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        .radio-group label:hover {
            border-color: #7A9E7E;
            background: #F0F6F1;
        }
        
        .radio-group input[type="radio"]:checked + span {
            color: #4A7A4F;
            font-weight: 600;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border: 1.5px solid #D9D4CC;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .checkbox-group label:hover {
            border-color: #7A9E7E;
            background: #F0F6F1;
        }
        
        .required {
            color: #C0392B;
        }

        /* Multi-step form styles */
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 34px;
            padding: 0 20px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #E8E4DE;
            z-index: 0;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #E8E4DE;
            color: #6B6B6B;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
            margin-bottom: 8px;
        }
        
        .step.completed .step-number {
            background: #7A9E7E;
            color: white;
        }
        
        .step.active .step-number {
            background: #C17A5A;
            color: white;
            box-shadow: 0 0 0 4px rgba(193,122,90,0.2);
        }
        
        .step-label {
            font-size: 0.75rem;
            color: #6B6B6B;
            font-weight: 500;
        }
        
        .step.active .step-label {
            color: #C17A5A;
            font-weight: 600;
        }
        
        .step.completed .step-label {
            color: #4A7A4F;
        }
        
        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #E8E4DE;
        }
        
        .btn-prev {
            background: none;
            border: 1.5px solid #D9D4CC;
            color: #6B6B6B;
            padding: 12px 28px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-prev:hover {
            border-color: #7A9E7E;
            color: #4A7A4F;
        }

        .save-draft-fab {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 999;
            background: #2C5A8C;
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 12px 18px;
            font-size: 0.86rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-next {
            background: linear-gradient(135deg, #C17A5A, #A85E3F);
            border: none;
            color: white;
            padding: 12px 32px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(193,122,90,0.35);
            transition: all 0.2s;
        }
        
        .btn-next:hover {
            transform: translateY(-2px);
        }
        
        .error {
            color: #C0392B;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        /* ── Mobile step indicator (hidden by default, shown on phones) ── */
        .step-indicator-mobile { display: none; }

        /* ── Validation error styles ── */
        .validation-errors {
            background: #FFF5F5;
            border: 1.5px solid #E8B0B0;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
        .validation-errors h4 {
            color: #C0392B;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .validation-errors ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .validation-errors li {
            font-size: 0.85rem;
            color: #6B3030;
            padding: 4px 0 4px 16px;
            position: relative;
        }
        .validation-errors li::before {
            content: '\2022';
            position: absolute;
            left: 0;
            color: #C0392B;
        }
        .field-error {
            border-color: #C0392B !important;
            box-shadow: 0 0 0 3px rgba(192,57,43,0.1) !important;
        }

        /* Submit validation modal */
        .submit-validation-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }
        .submit-validation-modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 12px 48px rgba(0,0,0,0.2);
        }
        .submit-validation-modal h3 {
            color: #C0392B;
            font-size: 1.1rem;
            margin-bottom: 16px;
        }
        .submit-validation-modal .step-group { margin-bottom: 16px; }
        .submit-validation-modal .step-group-title {
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            color: #C17A5A;
            margin-bottom: 6px;
        }
        .submit-validation-modal .step-group-title:hover { color: #A85E3F; }
        .submit-validation-modal ul {
            list-style: disc;
            padding-left: 20px;
            margin: 0;
        }
        .submit-validation-modal li {
            font-size: 0.85rem;
            color: #6B3030;
            padding: 2px 0;
        }
        .submit-validation-modal .modal-close {
            display: block; width: 100%; padding: 12px;
            background: linear-gradient(135deg, #C17A5A, #A85E3F);
            color: white; border: none; border-radius: 50px;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-top: 16px;
        }

        /* ── Responsive: Tablet ≤768px ── */
        @media (max-width: 768px) {
            .header { padding: 24px 16px; }
            .header h1 { font-size: 1.4rem; }
            .form-card { padding: 24px 16px; }
            .step-indicator { padding: 0 8px; margin-bottom: 24px; }
            .step-label { display: none; }
            .step-number { width: 28px; height: 28px; font-size: 0.8rem; }
            .step::after { top: 13px; }
            .form-step [style*="repeat(3, 1fr)"],
            .form-step [style*="1fr 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
            }
        }

        /* ── Responsive: Phone ≤480px ── */
        @media (max-width: 480px) {
            .container { padding: 8px; }
            .header { padding: 20px 12px; border-radius: 8px 8px 0 0; }
            .header h1 { font-size: 1.2rem; }
            .header p { font-size: 0.8rem; }
            .form-card { padding: 16px 12px; border-radius: 0 0 8px 8px; }
            .section-title { font-size: 1.1rem; margin-bottom: 16px; }
            .radio-group { gap: 8px; }
            .radio-group label { padding: 8px 12px; font-size: 0.85rem; }
            .step-indicator { display: none !important; }
            .step-indicator-mobile {
                display: block;
                text-align: center;
                margin-bottom: 20px;
                padding: 12px 0;
            }
            .step-mobile-text {
                font-size: 0.85rem;
                color: #6B6B6B;
            }
            .step-mobile-text strong {
                color: #C17A5A;
                font-size: 1rem;
            }
            .step-mobile-dots {
                display: flex;
                justify-content: center;
                gap: 6px;
                margin-top: 8px;
            }
            .step-mobile-dot {
                width: 8px; height: 8px;
                border-radius: 50%;
                background: #E8E4DE;
                transition: all 0.2s;
            }
            .step-mobile-dot.completed { background: #7A9E7E; }
            .step-mobile-dot.active {
                background: #C17A5A;
                width: 20px;
                border-radius: 4px;
            }
            .form-navigation {
                flex-direction: column-reverse;
                gap: 12px;
            }
            .btn-next, .btn-prev {
                width: 100%;
                text-align: center;
            }
            .form-step [style*="1fr 1fr"],
            .form-step [style*="repeat(3, 1fr)"],
            .form-step [style*="1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            .brand-avoid-entry [style*="grid-template-columns"] {
                grid-template-columns: 1fr auto !important;
            }
            .diet-entry, .hd-entry, .ct-entry, .treat-entry,
            .supp-entry, .rdc-entry, .ar-entry, .brand-avoid-entry {
                padding: 12px !important;
            }
            .submit-validation-modal { padding: 20px; border-radius: 12px; }
        }
    </style>
</head>
<body>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="app-shell">
    <aside class="app-sidebar" aria-label="Primary navigation">
        <div class="brand">POSHTIK NUTRIVET</div>
        <nav>
            <a href="{% url 'submission_history' %}">Dashboard</a>
            <a href="{% url 'appointments:pet_dashboard' %}">Appointments</a>
            <a class="active" href="{% url 'intake_form' %}">Intake Form</a>
            <a href="{% url 'homemade_diet_questionnaire' %}">Homemade Form</a>
            <a href="{% url 'logout' %}">Logout</a>
        </nav>
    </aside>
    <main id="main-content" class="app-main">
    <div class="container">
        <div class="header">
            <h1>Poshtik NutriVet</h1>
            <p>Canine Diet History Form</p>
            <div id="autosave-indicator" class="autosave-indicator" aria-live="polite">
                <span class="autosave-dot"></span>
                <span id="autosave-text">Draft sync ready</span>
            </div>
        </div>
        
        <div class="form-card">
            <form method="POST">
                {% csrf_token %}
                
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" data-step="1" onclick="goToStep(1)">
                        <div class="step-number" aria-hidden="true">1</div>
                        <div class="step-label">Owner & Pet</div>
                    </div>
                    <div class="step" data-step="2" onclick="goToStep(2)">
                        <div class="step-number" aria-hidden="true">2</div>
                        <div class="step-label">Household</div>
                    </div>
                    <div class="step" data-step="3" onclick="goToStep(3)">
                        <div class="step-number" aria-hidden="true">3</div>
                        <div class="step-label">Feeding</div>
                    </div>
                    <div class="step" data-step="4" onclick="goToStep(4)">
                        <div class="step-number" aria-hidden="true">4</div>
                        <div class="step-label">Preferences</div>
                    </div>
                    <div class="step" data-step="5" onclick="goToStep(5)">
                        <div class="step-number" aria-hidden="true">5</div>
                        <div class="step-label">Diet History</div>
                    </div>
                    <div class="step" data-step="6" onclick="goToStep(6)">
                        <div class="step-number" aria-hidden="true">6</div>
                        <div class="step-label">Fitness</div>
                    </div>
                    <div class="step" data-step="7" onclick="goToStep(7)">
                        <div class="step-number" aria-hidden="true">7</div>
                        <div class="step-label">Medical</div>
                    </div>
                    <div class="step" data-step="8" onclick="goToStep(8)">
                        <div class="step-number" aria-hidden="true">8</div>
                        <div class="step-label">Vaccination</div>
                    </div>
                    <div class="step" data-step="9" onclick="goToStep(9)">
                        <div class="step-number" aria-hidden="true">9</div>
                        <div class="step-label">Consent</div>
                    </div>
                </div>

                <!-- Mobile step indicator (visible only on phones ≤480px) -->
                <div class="step-indicator-mobile" id="step-indicator-mobile">
                    <span class="step-mobile-text">Step <strong id="mobile-step-num">1</strong> of 9 &mdash; <span id="mobile-step-label">Owner & Pet</span></span>
                    <div class="step-mobile-dots" id="mobile-step-dots"></div>
                </div>

                <!-- Step 1: Owner & Pet Info -->
                <div class="form-step active" id="step-1">
                
                <!-- Section 1: Pet Parent Info -->
                <h2 class="section-title">Pet Parent Information</h2>
                
                <div class="form-group">
                    <label>Your Name <span class="required">*</span></label>
                    <input type="text" name="parent_name" required>
                </div>
                
                <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" name="parent_email" required>
                </div>
                
                <div class="form-group">
                    <label>Phone Number <span class="required">*</span></label>
                    <input type="tel" name="parent_phone" required>
                </div>
                
                <div class="form-group">
                    <label>Location / Primary Vet Clinic</label>
                    <input type="text" name="parent_location">
                </div>
                
                <!-- Section 2: Pet Info -->
                <h2 class="section-title" style="margin-top: 40px;">Pet Information</h2>
                
                <div class="form-group">
                    <label>Pet Name <span class="required">*</span></label>
                    <input type="text" name="pet_name" required>
                </div>
                
                <div class="form-group">
                    <label>Date of Birth / Age <span class="required">*</span></label>
                    <input type="text" name="pet_age" placeholder="e.g., 3 years or 2020-05-15" required>
                </div>
                
                <div class="form-group">
                    <label>Species <span class="required">*</span></label>
                    <select name="pet_species" required>
                        <option value="">-- Select Species --</option>
                        <option value="dog">Dog</option>
                        <option value="cat">Cat</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Breed <span class="required">*</span></label>
                    <input type="text" name="pet_breed" required>
                </div>
                
                <div class="form-group">
                    <label>Colour</label>
                    <input type="text" name="pet_colour">
                </div>
                
                <div class="form-group">
                    <label>Sex <span class="required">*</span></label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="pet_sex" value="male" required>
                            <span>Male</span>
                        </label>
                        <label>
                            <input type="radio" name="pet_sex" value="female" required>
                            <span>Female</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Neutered / Spayed?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="pet_neutered" value="yes">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="pet_neutered" value="no">
                            <span>No</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Current Weight (kg) <span class="required">*</span></label>
                    <input type="number" step="0.01" name="pet_weight" required>
                </div>
                
                <div class="form-group">
                    <label>Body Condition <span class="required">*</span></label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="pet_body_condition" value="ideal" required>
                            <span>Ideal</span>
                        </label>
                        <label>
                            <input type="radio" name="pet_body_condition" value="underweight" required>
                            <span>Underweight</span>
                        </label>
                        <label>
                            <input type="radio" name="pet_body_condition" value="overweight" required>
                            <span>Overweight</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Your reasons and goals for this consultation <span class="required">*</span></label>
                    <textarea name="pet_consultation_goals" required></textarea>
                </div>

                <!-- Navigation for Step 1 -->
                    <div class="form-navigation">
                        <div></div>
                        <button type="button" class="btn-next" onclick="nextStep(2)">Next: Household →</button>
                    </div>
                </div>
                
                <!-- Step 2: Household Details -->
                <div class="form-step" id="step-2">
                <!-- Section 3: Household Details -->
                <h2 class="section-title" style="margin-top: 40px;">Household Details</h2>
                
                <div class="form-group">
                    <label>Do you have personal preferences to avoid certain food ingredients in your household?</label>
                    <textarea name="household_avoid_ingredients" placeholder="Please list any ingredients to avoid..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>If your pet's nutritional needs demand it, would it be possible for you to arrange for the food?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="household_arrange_food" value="yes">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="household_arrange_food" value="no">
                            <span>No</span>
                        </label>
                        <label>
                            <input type="radio" name="household_arrange_food" value="will_try">
                            <span>I will try my best</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Who feeds your pet daily?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="household_who_feeds" value="one_person" onclick="document.getElementById('feeder_name').style.display='block'">
                            <span>Only one person</span>
                        </label>
                        <label>
                            <input type="radio" name="household_who_feeds" value="varies" onclick="document.getElementById('feeder_name').style.display='block'">
                            <span>Varies from day-to-day</span>
                        </label>
                    </div>
                    <div id="feeder_name" style="display:none; margin-top:12px;">
                        <input type="text" name="household_feeder_name" placeholder="Who feeds the pet?" style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Do you have other pets at home?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="household_other_pets" value="yes" onclick="document.getElementById('other_pets_details').style.display='block'">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="household_other_pets" value="no" onclick="document.getElementById('other_pets_details').style.display='none'">
                            <span>No</span>
                        </label>
                    </div>
                    <div id="other_pets_details" style="display:none; margin-top:12px;">
                        <textarea name="household_other_pets_details" placeholder="Please specify (species, number, etc.)..." style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px; min-height:80px;"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Where is your pet housed?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="household_pet_housed" value="indoors">
                            <span>Indoors</span>
                        </label>
                        <label>
                            <input type="radio" name="household_pet_housed" value="outdoors">
                            <span>Outdoors</span>
                        </label>
                        <label>
                            <input type="radio" name="household_pet_housed" value="both">
                            <span>Both</span>
                        </label>
                    </div>
                </div>
                <!-- Navigation for Step 2 -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(1)">← Previous</button>
                        <button type="button" class="btn-next" onclick="nextStep(3)">Next: Feeding →</button>
                    </div>
                </div>
                
                <!-- Step 3: Feeding Management -->
                <div class="form-step" id="step-3">
                <!-- Section 4: Feeding Management & Behavior -->
                <h2 class="section-title" style="margin-top: 40px;">Feeding Management & Behavior</h2>
                
                <div class="form-group">
                    <label>Food is:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="feeding_food_availability" value="always" onclick="document.getElementById('food_times').style.display='none'">
                            <span>Always available during the day</span>
                        </label>
                        <label>
                            <input type="radio" name="feeding_food_availability" value="certain_times" onclick="document.getElementById('food_times').style.display='block'">
                            <span>Only at certain times</span>
                        </label>
                    </div>
                    <div id="food_times" style="display:none; margin-top:12px;">
                        <input type="text" name="feeding_food_times" placeholder="e.g., 8:00 AM and 6:00 PM" style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>How many meals are fed per day?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="feeding_meals_per_day" value="1"><span>1×</span></label>
                        <label><input type="radio" name="feeding_meals_per_day" value="2"><span>2×</span></label>
                        <label><input type="radio" name="feeding_meals_per_day" value="3"><span>3×</span></label>
                        <label><input type="radio" name="feeding_meals_per_day" value="4"><span>4× or more</span></label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>My pet: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="feeding_behaviors" value="eats_immediately"><span>Eats all the food as soon as it is offered</span></label>
                        <label><input type="checkbox" name="feeding_behaviors" value="nibbles"><span>Nibbles throughout the day</span></label>
                        <label><input type="checkbox" name="feeding_behaviors" value="returns_later"><span>Does not eat entire meal and returns later</span></label>
                        <label><input type="checkbox" name="feeding_behaviors" value="hand_fed"><span>Only eats when hand fed</span></label>
                        <label><input type="checkbox" name="feeding_behaviors" value="begs"><span>Begs for food between meals</span></label>
                        <label><input type="checkbox" name="feeding_behaviors" value="table_scraps"><span>Receives human food / table scraps</span></label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Has your pet's attitude towards food changed?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="feeding_attitude_changed" value="yes" onclick="document.getElementById('attitude_details').style.display='block'">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="feeding_attitude_changed" value="no" onclick="document.getElementById('attitude_details').style.display='none'">
                            <span>No</span>
                        </label>
                    </div>
                    <div id="attitude_details" style="display:none; margin-top:12px;">
                        <textarea name="feeding_attitude_details" placeholder="Please describe what changed..." style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px; min-height:80px;"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>Does your pet have access to any other food/unmonitored food source?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="feeding_unmonitored" value="yes" onclick="document.getElementById('unmonitored_sources').style.display='block'">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="feeding_unmonitored" value="no" onclick="document.getElementById('unmonitored_sources').style.display='none'">
                            <span>No</span>
                        </label>
                    </div>
                    <div id="unmonitored_sources" style="display:none; margin-top:12px;">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="unmonitored_sources" value="treats_neighbors"><span>Treats/food from neighbors, children, friends, etc.</span></label>
                            <label><input type="checkbox" name="unmonitored_sources" value="steals_bowls"><span>Steals from other pet's food bowls</span></label>
                            <label><input type="checkbox" name="unmonitored_sources" value="garbage"><span>Gets into garbage, scavenge</span></label>
                            <label><input type="checkbox" name="unmonitored_sources" value="prey"><span>Catches prey/hunt</span></label>
                        </div>
                        <input type="text" name="unmonitored_other" placeholder="Other, specify..." style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px; margin-top:8px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Good appetite?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="feeding_good_appetite" value="yes"><span>Yes</span></label>
                        <label><input type="radio" name="feeding_good_appetite" value="sometimes"><span>Sometimes</span></label>
                        <label><input type="radio" name="feeding_good_appetite" value="no"><span>No</span></label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Has appetite changed recently?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="feeding_appetite_recently" value="increased"><span>Increased</span></label>
                        <label><input type="radio" name="feeding_appetite_recently" value="same"><span>Stayed the same</span></label>
                        <label><input type="radio" name="feeding_appetite_recently" value="decreased"><span>Decreased</span></label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Type of feeding bowl used for your pet: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="bowl_types" value="standard"><span>Standard feeding bowl</span></label>
                        <label><input type="checkbox" name="bowl_types" value="slow_feeder"><span>Slow feeder bowls</span></label>
                        <label><input type="checkbox" name="bowl_types" value="elevated"><span>Elevated/raised feeding bowls</span></label>
                        <label><input type="checkbox" name="bowl_types" value="tilted"><span>Tilted feeding bowls</span></label>
                        <label><input type="checkbox" name="bowl_types" value="anti_spill"><span>Anti-spill/No tip bowls</span></label>
                        <label><input type="checkbox" name="bowl_types" value="puzzle"><span>Puzzle/Enrichment feeders</span></label>
                        <label><input type="checkbox" name="bowl_types" value="travel"><span>Travel/Portable bowls</span></label>
                        <label><input type="checkbox" name="bowl_types" value="special_therapeutic"><span>Special/therapeutic bowls (e.g. Bailey chairs, Lickmats)</span></label>
                    </div>
                    <input type="text" name="bowl_type_other" placeholder="Other, please specify..." style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px; margin-top:8px;">
                </div>
                
                <div class="form-group">
                    <label>Select the material of feeding bowls: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="bowl_material" value="stainless_steel"><span>Stainless Steel</span></label>
                        <label><input type="checkbox" name="bowl_material" value="ceramic"><span>Ceramic</span></label>
                        <label><input type="checkbox" name="bowl_material" value="plastic"><span>Plastic</span></label>
                        <label><input type="checkbox" name="bowl_material" value="silicone"><span>Silicone</span></label>
                    </div>
                    <input type="text" name="bowl_material_other" placeholder="Other, please specify..." style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px; margin-top:8px;">
                </div>
                
                <div class="form-group">
                    <label>Type of water bowl used for your pet: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="water_bowl_types" value="standard"><span>Standard water bowl</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="non_spill"><span>Non-spill/No tip water bowl</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="anti_splash"><span>Anti-splash/Splash guard</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="filtered"><span>Filtered water bowls</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="automatic"><span>Automatic water bowls</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="fountain"><span>Water fountains/continuous water flow</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="insulated"><span>Insulated/Cooling water bowls</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="travel"><span>Travel/Portable water bowl</span></label>
                        <label><input type="checkbox" name="water_bowl_types" value="medical"><span>Medical use water bowls</span></label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select the material of water bowls: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="water_bowl_material" value="stainless_steel"><span>Stainless Steel</span></label>
                        <label><input type="checkbox" name="water_bowl_material" value="ceramic"><span>Ceramic</span></label>
                        <label><input type="checkbox" name="water_bowl_material" value="plastic"><span>Plastic</span></label>
                        <label><input type="checkbox" name="water_bowl_material" value="silicone"><span>Silicone</span></label>
                    </div>
                    <input type="text" name="water_bowl_material_other" placeholder="Other, please specify..." style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px; margin-top:8px;">
                </div>
                
                <div class="form-group">
                    <label>Have you made any recent changes to your pet's diet (in the last 4 weeks)?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="recent_diet_change_4wks" value="yes" onclick="document.getElementById('recent_change_4wks').style.display='block'">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="recent_diet_change_4wks" value="no" onclick="document.getElementById('recent_change_4wks').style.display='none'">
                            <span>No</span>
                        </label>
                    </div>
                    <div id="recent_change_4wks" style="display:none; margin-top:12px;">
                        <textarea name="recent_change_4wks_details" placeholder="Please note what the change was and the reason for making it..." style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px; min-height:80px;"></textarea>
                    </div>
                </div>
                <!-- Navigation for Step 3 -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(2)">← Previous</button>
                        <button type="button" class="btn-next" onclick="nextStep(4)">Next: Preferences →</button>
                    </div>
                </div>
                
                <!-- Step 4: Food Preferences -->
                <div class="form-step" id="step-4">
                <!-- Section 5: Food Preferences -->
                <h2 class="section-title" style="margin-top: 40px;">Food Preferences</h2>
                
                <div class="form-group">
                    <label>Food preferences: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="food_preferences" value="canned"><span>Canned/Wet food</span></label>
                        <label><input type="checkbox" name="food_preferences" value="gravy"><span>Gravy</span></label>
                        <label><input type="checkbox" name="food_preferences" value="dry"><span>Dry food</span></label>
                        <label><input type="checkbox" name="food_preferences" value="homecooked"><span>Home cooked</span></label>
                        <label><input type="checkbox" name="food_preferences" value="raw"><span>Raw</span></label>
                        <label><input type="checkbox" name="food_preferences" value="commercial"><span>Commercial</span></label>
                        <label><input type="checkbox" name="food_preferences" value="no_preferences"><span>No preferences</span></label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Treat preferences: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="treat_preferences" value="commercial_processed"><span>Commercial processed treats</span></label>
                        <label><input type="checkbox" name="treat_preferences" value="dehydrated"><span>Dehydrated treats</span></label>
                        <label><input type="checkbox" name="treat_preferences" value="raw_scraps"><span>Raw food scraps</span></label>
                        <label><input type="checkbox" name="treat_preferences" value="homemade"><span>Homemade treats</span></label>
                        <label><input type="checkbox" name="treat_preferences" value="fresh_bones"><span>Fresh bones</span></label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Does your pet refuse any particular foods?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="food_refuses" value="yes" onclick="document.getElementById('refuses_details').style.display='block'">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="food_refuses" value="no" onclick="document.getElementById('refuses_details').style.display='none'">
                            <span>No</span>
                        </label>
                    </div>
                    <div id="refuses_details" style="display:none; margin-top:12px;">
                        <textarea name="food_refuses_details" placeholder="Which foods does your pet refuse?" style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px; min-height:60px;"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>What treats would you prefer in the diet plan?</label>
                    <textarea name="preferred_treats_in_plan" placeholder="e.g., chicken jerky, carrot sticks, etc."></textarea>
                </div>

                <!-- Q16: Treats preferred in diet plan -->
                <div class="form-group">
                    <label>Which treats would you prefer to be included in this plan? <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="treat_plan_preferences" value="commercial_store"><span>Commercial/Store bought treats</span></label>
                        <label><input type="checkbox" name="treat_plan_preferences" value="dehydrated"><span>Dehydrated treats</span></label>
                        <label><input type="checkbox" name="treat_plan_preferences" value="raw_bone"><span>Raw bone/meats</span></label>
                        <label><input type="checkbox" name="treat_plan_preferences" value="homemade_cooked"><span>Homemade cooked treats</span></label>
                    </div>
                </div>

                <!-- Q17: Brands to avoid (dynamic table) -->
                <h2 class="section-title" style="margin-top: 40px;">Brands to Avoid</h2>
                <p style="color:#6B6B6B; font-size:0.9rem; margin-bottom:16px;">Mention pet food brands you would wish to avoid in your pet's customized diet plan.</p>
                <div id="brand-avoid-container">
                    <div class="brand-avoid-entry" style="background:#FFF5F5; border:1.5px solid #E8C0B0; border-radius:10px; padding:16px; margin-bottom:12px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end;">
                            <div>
                                <label style="font-size:0.85rem;">Brand Name</label>
                                <input type="text" name="avoid_brand_name[]" placeholder="e.g., Brand X" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div>
                                <label style="font-size:0.85rem;">Reason</label>
                                <input type="text" name="avoid_brand_reason[]" placeholder="e.g., digestive issues" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <button type="button" onclick="this.closest('.brand-avoid-entry').remove()" style="background:#C0392B; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem; height:38px;">X</button>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addBrandAvoidRow()" style="background:none; border:1.5px dashed #C17A5A; color:#A85E3F; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; width:100%; margin-bottom:24px;">+ Add Another Brand</button>
                
                <div class="form-group">
                    <label>What is important for you when choosing your pet's food? <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="food_factors" value="price"><span>Price/value</span></label>
                        <label><input type="checkbox" name="food_factors" value="convenience"><span>Convenience to purchase</span></label>
                        <label><input type="checkbox" name="food_factors" value="quality"><span>Quality of ingredients</span></label>
                        <label><input type="checkbox" name="food_factors" value="skin_coat"><span>Skin/coat health</span></label>
                        <label><input type="checkbox" name="food_factors" value="dental"><span>Oral/dental care</span></label>
                        <label><input type="checkbox" name="food_factors" value="stool"><span>Stool quality</span></label>
                        <label><input type="checkbox" name="food_factors" value="palatability"><span>Palatability</span></label>
                        <label><input type="checkbox" name="food_factors" value="allergies"><span>Food sensitivity/allergies</span></label>
                    </div>
                </div>

                <!-- Q20: Advice Source -->
                <h2 class="section-title" style="margin-top: 40px;">Source of Advice</h2>
                <div class="form-group">
                    <label>Who is your go-to source of advice for your pet's care? <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="advice_sources" value="veterinarian"><span>Veterinarian</span></label>
                        <label><input type="checkbox" name="advice_sources" value="breeder"><span>Breeder</span></label>
                        <label><input type="checkbox" name="advice_sources" value="pet_store"><span>Pet store</span></label>
                        <label><input type="checkbox" name="advice_sources" value="friend_family"><span>Friend/family</span></label>
                        <label><input type="checkbox" name="advice_sources" value="book_magazine"><span>Book/magazine</span></label>
                        <label><input type="checkbox" name="advice_sources" value="internet"><span>Internet</span></label>
                    </div>
                    <input type="text" name="advice_source_other" placeholder="Other, specify..." style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px; margin-top:8px;">
                </div>

                <h2 class="section-title" style="margin-top: 40px;">Food Storage</h2>
                <p style="color:#6B6B6B; font-size:0.9rem; margin-bottom:16px;">How do you store opened packets/used pet food?</p>
                
                <div style="background:#F5F8F5; border:1.5px solid #D9D4CC; border-radius:10px; padding:24px; margin-bottom:24px;">
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:16px; font-weight:600; font-size:0.9rem; color:#4A7A4F;">
                        <div>Food Type</div>
                        <div>Storage Location</div>
                        <div>Time Period</div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:12px; align-items:center;">
                        <div style="font-weight:500;">Dry Food</div>
                        <input type="text" name="storage_dry_location" placeholder="e.g., airtight container" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        <input type="text" name="storage_dry_period" placeholder="e.g., 1 month" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:12px; align-items:center;">
                        <div style="font-weight:500;">Wet food/canned food</div>
                        <input type="text" name="storage_wet_location" placeholder="e.g., refrigerator" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        <input type="text" name="storage_wet_period" placeholder="e.g., 2-3 days" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:12px; align-items:center;">
                        <div style="font-weight:500;">Raw food</div>
                        <input type="text" name="storage_raw_location" placeholder="e.g., freezer" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        <input type="text" name="storage_raw_period" placeholder="e.g., 1 month" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:12px; align-items:center;">
                        <div style="font-weight:500;">Fresh home cooked food</div>
                        <input type="text" name="storage_homecooked_location" placeholder="e.g., refrigerator" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        <input type="text" name="storage_homecooked_period" placeholder="e.g., 3-4 days" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; align-items:center;">
                        <div style="font-weight:500;">Dehydrated food</div>
                        <input type="text" name="storage_dehydrated_location" placeholder="e.g., pantry" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        <input type="text" name="storage_dehydrated_period" placeholder="e.g., 6 months" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                    </div>
                </div>
                <!-- Navigation for Step 4 -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(3)">← Previous</button>
                        <button type="button" class="btn-next" onclick="nextStep(5)">Next: Diet History →</button>
                    </div>
                </div>
                
                <!-- Step 5: Diet History -->
                <div class="form-step" id="step-5">
                <!-- Section 6: Commercial Diet History (DYNAMIC TABLE) -->
                <h2 class="section-title" style="margin-top: 40px;">Commercial Diet History</h2>
                <p style="color:#6B6B6B; font-size:0.9rem; margin-bottom:16px;">List all commercial foods currently being fed. Click "Add Food" to add multiple foods.</p>
                
                <div id="diet-table-container">
                    <div class="diet-entry" style="background:#F5F8F5; border:1.5px solid #D9D4CC; border-radius:10px; padding:20px; margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <strong style="color:#4A7A4F;">Food Item #1</strong>
                            <button type="button" onclick="this.closest('.diet-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Diet Type</label>
                                <select name="diet_type[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                    <option value="">Select...</option>
                                    <option value="dry_kibble">Dry Kibble</option>
                                    <option value="wet_canned">Wet/Canned</option>
                                    <option value="raw">Raw</option>
                                    <option value="dehydrated">Dehydrated</option>
                                    <option value="fresh_frozen">Fresh/Freeze-dried</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Brand</label>
                                <input type="text" name="diet_brand[]" placeholder="e.g., Royal Canin" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Product Details</label>
                                <input type="text" name="diet_product[]" placeholder="e.g., Adult Medium Breed" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Amount per day (gm)</label>
                                <input type="text" name="diet_amount[]" placeholder="e.g., 150gm" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Meals per day</label>
                                <input type="number" name="diet_meals[]" placeholder="e.g., 2" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Food Topper Details (if any)</label>
                                <input type="text" name="diet_topper[]" placeholder="" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Topper Amount per meal (gm)</label>
                                <input type="text" name="diet_topper_amount[]" placeholder="" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Fed since</label>
                                <input type="text" name="diet_since[]" placeholder="e.g., 6 months" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Reason (if stopped)</label>
                                <input type="text" name="diet_reason_stopped[]" placeholder="" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addDietRow()" style="background:none; border:1.5px dashed #7A9E7E; color:#4A7A4F; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; width:100%; margin-bottom:24px;">+ Add Another Food</button>

                <!-- HOMEMADE DIET HISTORY (dynamic table) -->
                <h2 class="section-title" style="margin-top: 40px;">Homemade Diet History</h2>
                <p style="color:#6B6B6B; font-size:0.9rem; margin-bottom:16px;">If your pet is eating a homemade diet, specify ingredients, cooking method, and amounts.</p>
                <div id="hd-table-container">
                    <div class="hd-entry" style="background:#F5F0FF; border:1.5px solid #C8B8E8; border-radius:10px; padding:20px; margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <strong style="color:#6B4FA0;">Homemade Item #1</strong>
                            <button type="button" onclick="this.closest('.hd-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Ingredient/Food Item</label>
                                <input type="text" name="hd_ingredient[]" placeholder="e.g., chicken breast" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Raw Quantity per day (gm)</label>
                                <input type="text" name="hd_quantity[]" placeholder="e.g., 200gm" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Preparation Method</label>
                                <input type="text" name="hd_preparation[]" placeholder="e.g., boiled, baked" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Feed Frequency (per day)</label>
                                <input type="number" name="hd_frequency[]" placeholder="e.g., 2" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Fed Since</label>
                                <input type="text" name="hd_since[]" placeholder="e.g., 3 months" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Reason (if stopped)</label>
                                <input type="text" name="hd_reason_stopped[]" placeholder="" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addHomemadeDietRow()" style="background:none; border:1.5px dashed #6B4FA0; color:#6B4FA0; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; width:100%; margin-bottom:24px;">+ Add Another Homemade Item</button>

                <!-- COMMERCIAL TREAT HISTORY (dynamic table) -->
                <h2 class="section-title" style="margin-top: 40px;">Commercial Treat History</h2>
                <p style="color:#6B6B6B; font-size:0.9rem; margin-bottom:16px;">List all commercial treats being fed.</p>
                <div id="ct-table-container">
                    <div class="ct-entry" style="background:#FFF8E8; border:1.5px solid #E8D090; border-radius:10px; padding:20px; margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <strong style="color:#A08020;">Commercial Treat #1</strong>
                            <button type="button" onclick="this.closest('.ct-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Treat Type</label>
                                <input type="text" name="ct_type[]" placeholder="e.g., dental chew" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Brand</label>
                                <input type="text" name="ct_brand[]" placeholder="e.g., Pedigree" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Product Details</label>
                                <input type="text" name="ct_product[]" placeholder="" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Quantity per day (gm)</label>
                                <input type="text" name="ct_quantity[]" placeholder="e.g., 30g" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Fed Since</label>
                                <input type="text" name="ct_since[]" placeholder="e.g., 1 year" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Reason (if stopped)</label>
                                <input type="text" name="ct_reason_stopped[]" placeholder="" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addCommercialTreatRow()" style="background:none; border:1.5px dashed #A08020; color:#A08020; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; width:100%; margin-bottom:24px;">+ Add Another Commercial Treat</button>

                <h2 class="section-title" style="margin-top: 40px;">Homemade Treat History</h2>
                <p style="color:#6B6B6B; font-size:0.9rem; margin-bottom:16px;">List any homemade/human food treats given to your pet.</p>

                <div id="treat-table-container">
                    <div class="treat-entry" style="background:#FFF8F0; border:1.5px solid #E8D5B0; border-radius:10px; padding:20px; margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <strong style="color:#A85E3F;">Treat #1</strong>
                            <button type="button" onclick="this.closest('.treat-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Treat Type/Form</label>
                                <input type="text" name="treat_type_form[]" placeholder="e.g., biscuit, chunk" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Ingredient</label>
                                <input type="text" name="treat_ingredient[]" placeholder="e.g., chicken breast" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Preparation Method</label>
                                <input type="text" name="treat_preparation[]" placeholder="e.g., boiled" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Quantity per day (gm)</label>
                                <input type="text" name="treat_quantity[]" placeholder="e.g., 50gm" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Fed Since</label>
                                <input type="text" name="treat_since[]" placeholder="e.g., 6 months" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Reason (if stopped)</label>
                                <input type="text" name="treat_reason_stopped[]" placeholder="" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addTreatRow()" style="background:none; border:1.5px dashed #C17A5A; color:#A85E3F; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; width:100%; margin-bottom:24px;">+ Add Another Treat</button>
                
                <h2 class="section-title" style="margin-top: 40px;">Supplements</h2>

                <div class="form-group">
                    <label>Do you give any dietary supplements? (vitamins, minerals, herbal products, oils, etc.)</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="supplements_given" value="yes" onclick="document.getElementById('supplement_details').style.display='block'">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="supplements_given" value="no" onclick="document.getElementById('supplement_details').style.display='none'">
                            <span>No</span>
                        </label>
                    </div>
                    <div id="supplement_details" style="display:none; margin-top:16px;">
                        <div id="supplement-table-container">
                            <div class="supp-entry" style="background:#F5F8F5; border:1.5px solid #B8D4B8; border-radius:10px; padding:16px; margin-bottom:12px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                    <strong style="color:#4A7A4F;">Supplement #1</strong>
                                    <button type="button" onclick="this.closest('.supp-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                    <div>
                                        <label style="font-size:0.85rem;">Brand name</label>
                                        <input type="text" name="supplement_brand[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                    </div>
                                    <div>
                                        <label style="font-size:0.85rem;">Form</label>
                                        <input type="text" name="supplement_form[]" placeholder="tablet/powder/liquid" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                    </div>
                                    <div>
                                        <label style="font-size:0.85rem;">Amount</label>
                                        <input type="text" name="supplement_amount[]" placeholder="e.g., 500mg" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                    </div>
                                    <div>
                                        <label style="font-size:0.85rem;"># per day</label>
                                        <input type="number" name="supplement_per_day[]" placeholder="e.g., 1" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                    </div>
                                    <div>
                                        <label style="font-size:0.85rem;">Fed Since</label>
                                        <input type="text" name="supplement_since[]" placeholder="e.g., 2 months" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addSupplementRow()" style="background:none; border:1.5px dashed #7A9E7E; color:#4A7A4F; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; width:100%; margin-bottom:12px;">+ Add Another Supplement</button>
                    </div>
                </div>
                
                <h2 class="section-title" style="margin-top: 40px;">Recent Diet Changes (Last 2-3 Months)</h2>

                <div class="form-group">
                    <label>Has your pet's diet changed in the last 2-3 months?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="diet_changed_2_3_months" value="yes" onclick="document.getElementById('diet_changes_2_3').style.display='block'">
                            <span>Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="diet_changed_2_3_months" value="no" onclick="document.getElementById('diet_changes_2_3').style.display='none'">
                            <span>No</span>
                        </label>
                    </div>
                    <div id="diet_changes_2_3" style="display:none; margin-top:16px;">
                        <p style="color:#6B6B6B; font-size:0.85rem; margin-bottom:12px;">List all food, snacks, treats and supplements received in the last 2-3 months.</p>
                        <div id="rdc-table-container">
                            <div class="rdc-entry" style="background:#F0F5FF; border:1.5px solid #B0C4E8; border-radius:10px; padding:16px; margin-bottom:12px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                    <strong style="color:#2060A0;">Change #1</strong>
                                    <button type="button" onclick="this.closest('.rdc-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                    <div><label style="font-size:0.85rem;">Brand</label><input type="text" name="rdc_brand[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                    <div><label style="font-size:0.85rem;">Product / Food Ingredient</label><input type="text" name="rdc_product[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                    <div><label style="font-size:0.85rem;">Form / Type</label><input type="text" name="rdc_form[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                    <div><label style="font-size:0.85rem;">Amount per day (gm)</label><input type="text" name="rdc_amount[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                    <div><label style="font-size:0.85rem;"># of meals per day</label><input type="number" name="rdc_meals[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                    <div><label style="font-size:0.85rem;">Start date</label><input type="text" name="rdc_start[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                    <div><label style="font-size:0.85rem;">Stop date</label><input type="text" name="rdc_stop[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                    <div><label style="font-size:0.85rem;">Reason stopped</label><input type="text" name="rdc_reason[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addRdcRow()" style="background:none; border:1.5px dashed #2060A0; color:#2060A0; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; width:100%;">+ Add Another Change</button>
                    </div>
                </div>



                
                <script>
                let dietCounter = 1;
                function addDietRow() {
                    dietCounter++;
                    const container = document.getElementById('diet-table-container');
                    const newEntry = document.createElement('div');
                    newEntry.className = 'diet-entry';
                    newEntry.style.cssText = 'background:#F5F8F5; border:1.5px solid #D9D4CC; border-radius:10px; padding:20px; margin-bottom:16px;';
                    newEntry.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <strong style="color:#4A7A4F;">Food Item #${dietCounter}</strong>
                            <button type="button" onclick="this.closest('.diet-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Diet Type</label>
                                <select name="diet_type[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                    <option value="">Select...</option>
                                    <option value="dry_kibble">Dry Kibble</option>
                                    <option value="wet_canned">Wet/Canned</option>
                                    <option value="raw">Raw</option>
                                    <option value="dehydrated">Dehydrated</option>
                                    <option value="fresh_frozen">Fresh/Freeze-dried</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Brand</label>
                                <input type="text" name="diet_brand[]" placeholder="e.g., Royal Canin" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Product Details</label>
                                <input type="text" name="diet_product[]" placeholder="e.g., Adult Medium Breed" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Amount per day (gm)</label>
                                <input type="text" name="diet_amount[]" placeholder="e.g., 150gm" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Meals per day</label>
                                <input type="number" name="diet_meals[]" placeholder="e.g., 2" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Food Topper Details (if any)</label>
                                <input type="text" name="diet_topper[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Topper Amount per meal (gm)</label>
                                <input type="text" name="diet_topper_amount[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Fed since</label>
                                <input type="text" name="diet_since[]" placeholder="e.g., 6 months" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Reason (if stopped)</label>
                                <input type="text" name="diet_reason_stopped[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                        </div>
                    `;
                    container.appendChild(newEntry);
                }
                let hdCounter = 1;
                function addHomemadeDietRow() {
                    hdCounter++;
                    const container = document.getElementById('hd-table-container');
                    const e = document.createElement('div');
                    e.className = 'hd-entry';
                    e.style.cssText = 'background:#F5F0FF; border:1.5px solid #C8B8E8; border-radius:10px; padding:20px; margin-bottom:16px;';
                    e.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;"><strong style="color:#6B4FA0;">Homemade Item #${hdCounter}</strong><button type="button" onclick="this.closest('.hd-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;"><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Ingredient/Food Item</label><input type="text" name="hd_ingredient[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Raw Quantity per day (gm)</label><input type="text" name="hd_quantity[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Preparation Method</label><input type="text" name="hd_preparation[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Feed Frequency (per day)</label><input type="number" name="hd_frequency[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Fed Since</label><input type="text" name="hd_since[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Reason (if stopped)</label><input type="text" name="hd_reason_stopped[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div></div>`;
                    container.appendChild(e);
                }

                let ctCounter = 1;
                function addCommercialTreatRow() {
                    ctCounter++;
                    const container = document.getElementById('ct-table-container');
                    const e = document.createElement('div');
                    e.className = 'ct-entry';
                    e.style.cssText = 'background:#FFF8E8; border:1.5px solid #E8D090; border-radius:10px; padding:20px; margin-bottom:16px;';
                    e.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;"><strong style="color:#A08020;">Commercial Treat #${ctCounter}</strong><button type="button" onclick="this.closest('.ct-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;"><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Treat Type</label><input type="text" name="ct_type[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Brand</label><input type="text" name="ct_brand[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Product Details</label><input type="text" name="ct_product[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Quantity per day (gm)</label><input type="text" name="ct_quantity[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Fed Since</label><input type="text" name="ct_since[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div class="form-group" style="margin-bottom:12px;"><label style="font-size:0.85rem;">Reason (if stopped)</label><input type="text" name="ct_reason_stopped[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div></div>`;
                    container.appendChild(e);
                }

                let suppCounter = 1;
                function addSupplementRow() {
                    suppCounter++;
                    const container = document.getElementById('supplement-table-container');
                    const e = document.createElement('div');
                    e.className = 'supp-entry';
                    e.style.cssText = 'background:#F5F8F5; border:1.5px solid #B8D4B8; border-radius:10px; padding:16px; margin-bottom:12px;';
                    e.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><strong style="color:#4A7A4F;">Supplement #${suppCounter}</strong><button type="button" onclick="this.closest('.supp-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;"><div><label style="font-size:0.85rem;">Brand name</label><input type="text" name="supplement_brand[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Form</label><input type="text" name="supplement_form[]" placeholder="tablet/powder/liquid" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Amount</label><input type="text" name="supplement_amount[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;"># per day</label><input type="number" name="supplement_per_day[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Fed Since</label><input type="text" name="supplement_since[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div></div>`;
                    container.appendChild(e);
                }

                let rdcCounter = 1;
                function addRdcRow() {
                    rdcCounter++;
                    const container = document.getElementById('rdc-table-container');
                    const e = document.createElement('div');
                    e.className = 'rdc-entry';
                    e.style.cssText = 'background:#F0F5FF; border:1.5px solid #B0C4E8; border-radius:10px; padding:16px; margin-bottom:12px;';
                    e.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><strong style="color:#2060A0;">Change #${rdcCounter}</strong><button type="button" onclick="this.closest('.rdc-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;"><div><label style="font-size:0.85rem;">Brand</label><input type="text" name="rdc_brand[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Product / Food Ingredient</label><input type="text" name="rdc_product[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Form / Type</label><input type="text" name="rdc_form[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Amount per day (gm)</label><input type="text" name="rdc_amount[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;"># of meals per day</label><input type="number" name="rdc_meals[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Start date</label><input type="text" name="rdc_start[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Stop date</label><input type="text" name="rdc_stop[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Reason stopped</label><input type="text" name="rdc_reason[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div></div>`;
                    container.appendChild(e);
                }

                function addBrandAvoidRow() {
                    const container = document.getElementById('brand-avoid-container');
                    const e = document.createElement('div');
                    e.className = 'brand-avoid-entry';
                    e.style.cssText = 'background:#FFF5F5; border:1.5px solid #E8C0B0; border-radius:10px; padding:16px; margin-bottom:12px;';
                    e.innerHTML = `<div style="display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end;"><div><label style="font-size:0.85rem;">Brand Name</label><input type="text" name="avoid_brand_name[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Reason</label><input type="text" name="avoid_brand_reason[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><button type="button" onclick="this.closest('.brand-avoid-entry').remove()" style="background:#C0392B; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem; height:38px;">X</button></div>`;
                    container.appendChild(e);
                }

                let arCounter = 1;
                function addAdverseReactionRow() {
                    arCounter++;
                    const container = document.getElementById('ar-table-container');
                    const e = document.createElement('div');
                    e.className = 'ar-entry';
                    e.style.cssText = 'background:#FFF0F0; border:1.5px solid #E8B0B0; border-radius:10px; padding:16px; margin-bottom:12px;';
                    e.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><strong style="color:#A02020;">Reaction #${arCounter}</strong><button type="button" onclick="this.closest('.ar-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;"><div><label style="font-size:0.85rem;">Brand</label><input type="text" name="ar_brand[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Product/Food Ingredient/Medication</label><input type="text" name="ar_product[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Form/Type</label><input type="text" name="ar_form[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div><label style="font-size:0.85rem;">Fed Since</label><input type="text" name="ar_since[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div><div style="grid-column:span 2;"><label style="font-size:0.85rem;">Details of reaction/Symptoms</label><textarea name="ar_symptoms[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px; min-height:60px;"></textarea></div></div>`;
                    container.appendChild(e);
                }

                let treatCounter = 1;
                function addTreatRow() {
                    treatCounter++;
                    const container = document.getElementById('treat-table-container');
                    const newEntry = document.createElement('div');
                    newEntry.className = 'treat-entry';
                    newEntry.style.cssText = 'background:#FFF8F0; border:1.5px solid #E8D5B0; border-radius:10px; padding:20px; margin-bottom:16px;';
                    newEntry.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <strong style="color:#A85E3F;">Treat #${treatCounter}</strong>
                            <button type="button" onclick="this.closest('.treat-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Treat Type/Form</label>
                                <input type="text" name="treat_type_form[]" placeholder="e.g., biscuit, chunk" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Ingredient</label>
                                <input type="text" name="treat_ingredient[]" placeholder="e.g., chicken breast" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Preparation Method</label>
                                <input type="text" name="treat_preparation[]" placeholder="e.g., boiled" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Quantity per day (gm)</label>
                                <input type="text" name="treat_quantity[]" placeholder="e.g., 50gm" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Fed Since</label>
                                <input type="text" name="treat_since[]" placeholder="e.g., 6 months" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:0.85rem;">Reason (if stopped)</label>
                                <input type="text" name="treat_reason_stopped[]" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                            </div>
                        </div>
                    `;
                    container.appendChild(newEntry);
                }
                </script>
            <script>
                let currentStep = 1;

                // ── Validation Toggle ──────────────────────────────────
                var VALIDATION_ENABLED = !new URLSearchParams(window.location.search).has('novalidate');

                // Dev-tools floating toggle (add ?devtools to URL)
                if (new URLSearchParams(window.location.search).has('devtools')) {
                    var devBtn = document.createElement('button');
                    devBtn.textContent = 'Validation: ON';
                    devBtn.style.cssText = 'position:fixed;bottom:16px;right:16px;z-index:99999;padding:8px 16px;border-radius:8px;border:2px solid #5B8C5A;background:#fff;color:#5B8C5A;font-weight:700;font-size:13px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15);';
                    devBtn.onclick = function() {
                        VALIDATION_ENABLED = !VALIDATION_ENABLED;
                        devBtn.textContent = 'Validation: ' + (VALIDATION_ENABLED ? 'ON' : 'OFF');
                        devBtn.style.borderColor = VALIDATION_ENABLED ? '#5B8C5A' : '#c0392b';
                        devBtn.style.color = VALIDATION_ENABLED ? '#5B8C5A' : '#c0392b';
                    };
                    document.body.appendChild(devBtn);
                }

                // ── Step Labels ────────────────────────────────────────
                var STEP_LABELS = [
                    '', 'Owner & Pet', 'Health & Diet', 'Diet Details',
                    'Homemade Diet', 'Treats & Supplements', 'Brands to Avoid',
                    'Additional Info', 'Veterinarian', 'Consent & Submit'
                ];

                // ── Required Fields Map ────────────────────────────────
                var STEP_REQUIRED_FIELDS = {
                    1: [
                        { name: 'parent_name', label: 'Parent/Owner Name', type: 'text' },
                        { name: 'parent_email', label: 'Email Address', type: 'email' },
                        { name: 'parent_phone', label: 'Phone Number', type: 'text' },
                        { name: 'pet_name', label: 'Pet Name', type: 'text' },
                        { name: 'pet_age', label: 'Pet Age', type: 'text' },
                        { name: 'pet_species', label: 'Species', type: 'select' },
                        { name: 'pet_breed', label: 'Breed', type: 'text' },
                        { name: 'pet_sex', label: 'Pet Sex', type: 'radio' },
                        { name: 'pet_weight', label: 'Body Weight', type: 'text' },
                        { name: 'pet_body_condition', label: 'Body Condition Score', type: 'radio' },
                        { name: 'pet_consultation_goals', label: 'Consultation Goals', type: 'text' }
                    ],
                    2: [], 3: [], 4: [], 5: [], 6: [], 7: [],
                    8: [
                        { name: 'vet_name', label: 'Veterinarian Name', type: 'text' },
                        { name: 'vet_practice', label: 'Practice / Clinic Name', type: 'text' },
                        { name: 'vet_phone', label: 'Vet Phone Number', type: 'text' },
                        { name: 'vet_email', label: 'Vet Email Address', type: 'email' }
                    ],
                    9: [
                        { name: 'consent_agreed', label: 'Consent Checkbox', type: 'checkbox' },
                        { name: 'consent_name', label: 'Full Name (Consent)', type: 'text' }
                    ]
                };

                // ── Mobile Step Indicator ──────────────────────────────
                function updateMobileStepIndicator(step) {
                    var numEl = document.getElementById('mobile-step-num');
                    var labelEl = document.getElementById('mobile-step-label');
                    var dotsEl = document.getElementById('mobile-step-dots');
                    if (!numEl || !labelEl || !dotsEl) return;

                    numEl.textContent = step;
                    labelEl.textContent = STEP_LABELS[step] || '';

                    dotsEl.innerHTML = '';
                    for (var i = 1; i <= 9; i++) {
                        var dot = document.createElement('span');
                        dot.className = 'step-mobile-dot' + (i === step ? ' active' : '') + (i < step ? ' completed' : '');
                        dotsEl.appendChild(dot);
                    }
                }

                // ── Validate Step ──────────────────────────────────────
                function validateStep(stepNum) {
                    var fields = STEP_REQUIRED_FIELDS[stepNum];
                    if (!fields || fields.length === 0) return [];

                    var missing = [];
                    var stepEl = document.getElementById('step-' + stepNum);

                    for (var i = 0; i < fields.length; i++) {
                        var f = fields[i];
                        var valid = false;

                        if (f.type === 'radio') {
                            var radios = stepEl.querySelectorAll('input[name="' + f.name + '"]');
                            for (var r = 0; r < radios.length; r++) {
                                if (radios[r].checked) { valid = true; break; }
                            }
                        } else if (f.type === 'checkbox') {
                            var cb = stepEl.querySelector('input[name="' + f.name + '"]');
                            valid = cb && cb.checked;
                        } else if (f.type === 'select') {
                            var sel = stepEl.querySelector('select[name="' + f.name + '"]');
                            valid = sel && sel.value && sel.value.trim() !== '';
                        } else {
                            var inp = stepEl.querySelector('[name="' + f.name + '"]');
                            valid = inp && inp.value && inp.value.trim() !== '';
                        }

                        if (!valid) {
                            var fieldEl = stepEl.querySelector('[name="' + f.name + '"]');
                            missing.push({ label: f.label, step: stepNum, fieldEl: fieldEl, name: f.name, type: f.type });
                        }
                    }
                    return missing;
                }

                // ── Show Step Errors ───────────────────────────────────
                function showStepErrors(stepNum, missingFields) {
                    clearStepErrors(stepNum);

                    var stepEl = document.getElementById('step-' + stepNum);
                    if (!stepEl) return;

                    // Create error banner
                    var banner = document.createElement('div');
                    banner.className = 'validation-errors';
                    banner.id = 'validation-errors-' + stepNum;
                    var title = document.createElement('strong');
                    title.textContent = 'Please fill in the following required fields:';
                    banner.appendChild(title);
                    var ul = document.createElement('ul');
                    ul.style.cssText = 'margin:8px 0 0 0; padding-left:20px;';
                    for (var i = 0; i < missingFields.length; i++) {
                        var li = document.createElement('li');
                        li.textContent = missingFields[i].label;
                        li.style.marginBottom = '2px';
                        ul.appendChild(li);
                    }
                    banner.appendChild(ul);

                    // Insert at top of step content
                    stepEl.insertBefore(banner, stepEl.firstChild);

                    // Highlight fields
                    for (var j = 0; j < missingFields.length; j++) {
                        var mf = missingFields[j];
                        if (mf.type === 'radio') {
                            // Highlight the radio group container
                            var radios = stepEl.querySelectorAll('input[name="' + mf.name + '"]');
                            for (var r = 0; r < radios.length; r++) {
                                var radioLabel = radios[r].closest('label') || radios[r].closest('.radio-group');
                                if (radioLabel) radioLabel.classList.add('field-error');
                            }
                        } else if (mf.fieldEl) {
                            mf.fieldEl.classList.add('field-error');
                        }
                    }

                    // Scroll to banner
                    banner.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                // ── Clear Step Errors ──────────────────────────────────
                function clearStepErrors(stepNum) {
                    var banner = document.getElementById('validation-errors-' + stepNum);
                    if (banner) banner.remove();

                    var stepEl = document.getElementById('step-' + stepNum);
                    if (!stepEl) return;
                    var highlighted = stepEl.querySelectorAll('.field-error');
                    for (var i = 0; i < highlighted.length; i++) {
                        highlighted[i].classList.remove('field-error');
                    }
                }

                // ── Auto-clear field errors on input ───────────────────
                function setupFieldErrorClearListeners() {
                    document.addEventListener('input', function(e) {
                        if (e.target.classList.contains('field-error')) {
                            e.target.classList.remove('field-error');
                        }
                    });
                    document.addEventListener('change', function(e) {
                        var el = e.target;
                        if (el.classList.contains('field-error')) {
                            el.classList.remove('field-error');
                        }
                        // For radios, clear from all labels in the group
                        if (el.type === 'radio') {
                            var groupLabels = document.querySelectorAll('input[name="' + el.name + '"]');
                            for (var i = 0; i < groupLabels.length; i++) {
                                var lbl = groupLabels[i].closest('label') || groupLabels[i].closest('.radio-group');
                                if (lbl) lbl.classList.remove('field-error');
                            }
                        }
                        // For checkboxes
                        if (el.type === 'checkbox' && el.classList.contains('field-error')) {
                            el.classList.remove('field-error');
                        }
                    });
                }
                setupFieldErrorClearListeners();

                // ── Navigation Functions ───────────────────────────────
                function nextStep(step) {
                    // Validate current step before moving forward
                    if (VALIDATION_ENABLED) {
                        var missing = validateStep(currentStep);
                        if (missing.length > 0) {
                            showStepErrors(currentStep, missing);
                            return;
                        }
                        clearStepErrors(currentStep);
                    }

                    // Hide current step
                    document.getElementById('step-' + currentStep).classList.remove('active');

                    // Mark current as completed
                    document.querySelector('.step[data-step="' + currentStep + '"]').classList.add('completed');
                    document.querySelector('.step[data-step="' + currentStep + '"]').classList.remove('active');

                    // Show next step
                    currentStep = step;
                    document.getElementById('step-' + currentStep).classList.add('active');
                    document.querySelector('.step[data-step="' + currentStep + '"]').classList.add('active');

                    updateMobileStepIndicator(currentStep);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                function prevStep(step) {
                    // Going back never blocks — no validation
                    document.getElementById('step-' + currentStep).classList.remove('active');
                    document.querySelector('.step[data-step="' + currentStep + '"]').classList.remove('active');

                    currentStep = step;
                    document.getElementById('step-' + currentStep).classList.add('active');
                    document.querySelector('.step[data-step="' + currentStep + '"]').classList.add('active');

                    updateMobileStepIndicator(currentStep);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                function goToStep(step) {
                    if (step === currentStep) return;

                    // Going backward — always allowed
                    if (step < currentStep) {
                        goToStepDirect(step);
                        return;
                    }

                    // Going forward — validate each intermediate step
                    if (VALIDATION_ENABLED) {
                        for (var s = currentStep; s < step; s++) {
                            var missing = validateStep(s);
                            if (missing.length > 0) {
                                // Navigate to the failing step and show errors
                                goToStepDirect(s);
                                showStepErrors(s, missing);
                                return;
                            }
                        }
                    }

                    goToStepDirect(step);
                }

                // Non-validating direct navigation (used by modal + backward nav)
                function goToStepDirect(step) {
                    if (step === currentStep) return;

                    document.getElementById('step-' + currentStep).classList.remove('active');

                    for (var i = 1; i <= 9; i++) {
                        var indicator = document.querySelector('.step[data-step="' + i + '"]');
                        indicator.classList.remove('active', 'completed');
                        if (i < step) indicator.classList.add('completed');
                    }

                    currentStep = step;
                    document.getElementById('step-' + currentStep).classList.add('active');
                    document.querySelector('.step[data-step="' + currentStep + '"]').classList.add('active');

                    updateMobileStepIndicator(currentStep);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                // ── Submit Handler ─────────────────────────────────────
                function submitForm(action) {
                    action = action || 'submit';
                    if (action === 'submit' && VALIDATION_ENABLED) {
                        var allMissing = [];
                        for (var s = 1; s <= 9; s++) {
                            var missing = validateStep(s);
                            for (var m = 0; m < missing.length; m++) {
                                allMissing.push(missing[m]);
                            }
                        }
                        if (allMissing.length > 0) {
                            showSubmitValidationModal(allMissing);
                            return;
                        }
                    }

                    if (action === 'submit') {
                        // Strip required from hidden steps so browser doesn't block
                        var hiddenSteps = document.querySelectorAll('.form-step:not(.active)');
                        hiddenSteps.forEach(function(step) {
                            step.querySelectorAll('[required]').forEach(function(el) {
                                el.removeAttribute('required');
                            });
                        });
                    }

                    var form = document.querySelector('form');
                    var oldAction = form.querySelector('input[name="action"]');
                    if (oldAction) oldAction.remove();
                    var hiddenAction = document.createElement('input');
                    hiddenAction.type = 'hidden';
                    hiddenAction.name = 'action';
                    hiddenAction.value = action;
                    form.appendChild(hiddenAction);

                    var oldStep = form.querySelector('input[name="current_step"]');
                    if (oldStep) oldStep.remove();
                    var hiddenStep = document.createElement('input');
                    hiddenStep.type = 'hidden';
                    hiddenStep.name = 'current_step';
                    hiddenStep.value = currentStep;
                    form.appendChild(hiddenStep);

                    form.submit();
                }

                // ── Submit Validation Modal ────────────────────────────
                function showSubmitValidationModal(allMissing) {
                    // Remove existing modal if any
                    var existing = document.getElementById('submit-validation-overlay');
                    if (existing) existing.remove();

                    // Group by step
                    var grouped = {};
                    for (var i = 0; i < allMissing.length; i++) {
                        var s = allMissing[i].step;
                        if (!grouped[s]) grouped[s] = [];
                        grouped[s].push(allMissing[i]);
                    }

                    // Build modal
                    var overlay = document.createElement('div');
                    overlay.className = 'submit-validation-overlay';
                    overlay.id = 'submit-validation-overlay';

                    var modal = document.createElement('div');
                    modal.className = 'submit-validation-modal';

                    var title = document.createElement('h3');
                    title.style.cssText = 'margin:0 0 8px 0; color:#c0392b; font-size:1.15rem;';
                    title.textContent = 'Required Fields Missing';
                    modal.appendChild(title);

                    var subtitle = document.createElement('p');
                    subtitle.style.cssText = 'margin:0 0 16px 0; color:#6B6B6B; font-size:0.9rem;';
                    subtitle.textContent = 'Please fill in all required fields before submitting. Click a step name to go there.';
                    modal.appendChild(subtitle);

                    var stepNums = Object.keys(grouped).sort(function(a, b) { return a - b; });
                    for (var si = 0; si < stepNums.length; si++) {
                        var stepNum = parseInt(stepNums[si]);
                        var fields = grouped[stepNum];

                        var stepLink = document.createElement('div');
                        stepLink.style.cssText = 'cursor:pointer; padding:6px 10px; margin:4px 0; background:#fdf2f2; border-radius:6px; border-left:3px solid #c0392b;';
                        stepLink.setAttribute('data-goto-step', stepNum);
                        stepLink.onmouseover = function() { this.style.background = '#fbe5e5'; };
                        stepLink.onmouseout = function() { this.style.background = '#fdf2f2'; };

                        var stepTitle = document.createElement('strong');
                        stepTitle.style.cssText = 'color:#5B8C5A; font-size:0.95rem;';
                        stepTitle.textContent = 'Step ' + stepNum + ' — ' + STEP_LABELS[stepNum];
                        stepLink.appendChild(stepTitle);

                        var fieldList = document.createElement('ul');
                        fieldList.style.cssText = 'margin:4px 0 0 0; padding-left:18px; font-size:0.88rem; color:#444;';
                        for (var fi = 0; fi < fields.length; fi++) {
                            var li = document.createElement('li');
                            li.textContent = fields[fi].label;
                            li.style.marginBottom = '1px';
                            fieldList.appendChild(li);
                        }
                        stepLink.appendChild(fieldList);

                        // Closure for click handler
                        (function(sn) {
                            stepLink.addEventListener('click', function() {
                                overlay.remove();
                                goToStepDirect(sn);
                                var stepMissing = validateStep(sn);
                                if (stepMissing.length > 0) showStepErrors(sn, stepMissing);
                            });
                        })(stepNum);

                        modal.appendChild(stepLink);
                    }

                    // Close button
                    var closeBtn = document.createElement('button');
                    closeBtn.type = 'button';
                    closeBtn.style.cssText = 'margin-top:16px; width:100%; padding:12px; border:none; border-radius:8px; background:#5B8C5A; color:#fff; font-size:1rem; font-weight:600; cursor:pointer;';
                    closeBtn.textContent = 'Close & Fix Fields';
                    closeBtn.onclick = function() {
                        overlay.remove();
                        var firstStep = parseInt(stepNums[0]);
                        goToStepDirect(firstStep);
                        var stepMissing = validateStep(firstStep);
                        if (stepMissing.length > 0) showStepErrors(firstStep, stepMissing);
                    };
                    modal.appendChild(closeBtn);

                    overlay.appendChild(modal);

                    // Click outside to close
                    overlay.addEventListener('click', function(e) {
                        if (e.target === overlay) overlay.remove();
                    });

                    document.body.appendChild(overlay);
                }

                // Initialize mobile indicator on page load
                updateMobileStepIndicator(1);
                </script>
                <!-- Diet Plan Preferences -->
                <h2 class="section-title" style="margin-top: 40px;">Diet Plan Preferences</h2>
                <p style="color:#6B6B6B; font-size:0.9rem; margin-bottom:16px;">If you are requesting a diet plan, please select your preference(s):</p>
                <div class="form-group">
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="diet_plan_preferences" value="dry_kibble_only"><span>Dry Kibble only</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="wet_canned_only"><span>Wet/canned only</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="combo_dry_wet"><span>A combination of both commercial dry (kibble) and wet (canned) food</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="combo_wet_homecooked"><span>A combination of commercial diet (wet) and homecooked food</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="combo_dry_homecooked"><span>A combination of commercial diet (dry) and homecooked food</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="only_homecooked"><span>Only home-cooked food</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="avoid_commercial"><span>Avoid commercial diets</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="include_commercial_treats"><span>Include commercial treats</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="avoid_commercial_treats"><span>Avoid commercial treats</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="include_homecooked_treats"><span>Include home cooked treats</span></label>
                        <label><input type="checkbox" name="diet_plan_preferences" value="unsure"><span>Unsure</span></label>
                    </div>
                </div>

               <!-- Navigation for Step 5 -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(4)">← Previous</button>
                        <button type="button" class="btn-next" onclick="nextStep(6)">Next: Fitness →</button>
                    </div>
                </div>
                
                <!-- Step 6: Fitness & Activity -->
                <div class="form-step" id="step-6">
                    <h2 class="section-title">Fitness & Activity</h2>

                    <div class="form-group">
                        <label>How active is your pet?</label>
                        <div class="radio-group" style="flex-direction:column;">
                            <label><input type="radio" name="activity_level" value="very_active"><span>Very active/athlete (daily hikes, training, sports, working dog)</span></label>
                            <label><input type="radio" name="activity_level" value="high"><span>High (back yard play, daily long walks or dog park)</span></label>
                            <label><input type="radio" name="activity_level" value="moderate"><span>Moderate (short daily walks, regular back yard play)</span></label>
                            <label><input type="radio" name="activity_level" value="average"><span>Average walks occasionally, no strenuous exercise</span></label>
                            <label><input type="radio" name="activity_level" value="hardly_moves"><span>Hardly moves (unable to tolerate any strenuous activity)</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>How much exercise does your pet get each day?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="exercise_duration" value="never"><span>Never</span></label>
                            <label><input type="radio" name="exercise_duration" value="not_every_day"><span>Not every day</span></label>
                            <label><input type="radio" name="exercise_duration" value="lt_15min"><span>&lt;15mins</span></label>
                            <label><input type="radio" name="exercise_duration" value="lt_30min"><span>&lt;30mins</span></label>
                            <label><input type="radio" name="exercise_duration" value="lt_45min"><span>&lt;45mins</span></label>
                            <label><input type="radio" name="exercise_duration" value="lt_1hr"><span>&lt;1 hour</span></label>
                            <label><input type="radio" name="exercise_duration" value="gt_1hr"><span>&gt;1 hour</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>How often is your pet leash walked on average?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="leash_walk_frequency" value="never"><span>Never</span></label>
                            <label><input type="radio" name="leash_walk_frequency" value="lt_1x"><span>&lt;1x/day</span></label>
                            <label><input type="radio" name="leash_walk_frequency" value="1_2x"><span>1-2x/day</span></label>
                            <label><input type="radio" name="leash_walk_frequency" value="gt_3x"><span>&gt;3x/day</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Does your pet have free access to a fenced yard/garden?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="fenced_yard" value="yes"><span>Yes</span></label>
                            <label><input type="radio" name="fenced_yard" value="no"><span>No</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>My pet is a:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="urban_rural" value="urban"><span>Urban based pet</span></label>
                            <label><input type="radio" name="urban_rural" value="rural"><span>Rural based</span></label>
                            <label><input type="radio" name="urban_rural" value="both"><span>Mix of both</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>My pet is my travel buddy:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="travel_buddy" value="yes" onclick="document.getElementById('travel_modes_div').style.display='block'"><span>Yes</span></label>
                            <label><input type="radio" name="travel_buddy" value="no" onclick="document.getElementById('travel_modes_div').style.display='none'"><span>No</span></label>
                            <label><input type="radio" name="travel_buddy" value="sometimes" onclick="document.getElementById('travel_modes_div').style.display='block'"><span>Sometimes</span></label>
                        </div>
                        <div id="travel_modes_div" style="display:none; margin-top:12px;">
                            <input type="text" name="travel_modes" placeholder="Modes of transport used..." style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Describe the exercise: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="exercise_types" value="run"><span>Run</span></label>
                            <label><input type="checkbox" name="exercise_types" value="walk"><span>Walk</span></label>
                            <label><input type="checkbox" name="exercise_types" value="fetch"><span>Fetch</span></label>
                            <label><input type="checkbox" name="exercise_types" value="pulling"><span>Pulling</span></label>
                            <label><input type="checkbox" name="exercise_types" value="agility"><span>Agility</span></label>
                            <label><input type="checkbox" name="exercise_types" value="swimming"><span>Swimming</span></label>
                        </div>
                    </div>

                    <!-- Activity Details Table (Q28) -->
                    <h2 class="section-title" style="margin-top: 30px;">Daily Activity Details</h2>
                    <div style="background:#F5F8F5; border:1.5px solid #D9D4CC; border-radius:10px; padding:24px; margin-bottom:24px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:12px; font-weight:600; font-size:0.9rem; color:#4A7A4F;">
                            <div>Activity Type</div><div>Time (mins) / Distance</div><div>Frequency / week</div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:10px; align-items:center;">
                            <div style="font-weight:500;">Run</div>
                            <input type="text" name="activity_run_duration" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                            <input type="text" name="activity_run_frequency" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:10px; align-items:center;">
                            <div style="font-weight:500;">Walk</div>
                            <input type="text" name="activity_walk_duration" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                            <input type="text" name="activity_walk_frequency" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:10px; align-items:center;">
                            <div style="font-weight:500;">Fetch</div>
                            <input type="text" name="activity_fetch_duration" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                            <input type="text" name="activity_fetch_frequency" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:10px; align-items:center;">
                            <div style="font-weight:500;">Pulling/Tugging</div>
                            <input type="text" name="activity_pulling_duration" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                            <input type="text" name="activity_pulling_frequency" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:10px; align-items:center;">
                            <div style="font-weight:500;">Agility</div>
                            <input type="text" name="activity_agility_duration" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                            <input type="text" name="activity_agility_frequency" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; align-items:center;">
                            <div style="font-weight:500;">Swimming</div>
                            <input type="text" name="activity_swimming_duration" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                            <input type="text" name="activity_swimming_frequency" placeholder="" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:6px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Is your pet currently training/a show dog?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="training_show_dog" value="yes" onclick="document.getElementById('training_details_div').style.display='block'"><span>Yes</span></label>
                            <label><input type="radio" name="training_show_dog" value="no" onclick="document.getElementById('training_details_div').style.display='none'"><span>No</span></label>
                        </div>
                        <div id="training_details_div" style="display:none; margin-top:12px;">
                            <input type="text" name="training_details" placeholder="Please specify..." style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Has there been any recent changes in activity?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="recent_activity_changes" value="yes" onclick="document.getElementById('activity_change_div').style.display='block'"><span>Yes</span></label>
                            <label><input type="radio" name="recent_activity_changes" value="no" onclick="document.getElementById('activity_change_div').style.display='none'"><span>No</span></label>
                        </div>
                        <div id="activity_change_div" style="display:none; margin-top:12px;">
                            <input type="text" name="activity_change_details" placeholder="Please specify..." style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Would increasing exercise duration be feasible?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="increase_exercise" value="yes"><span>Yes</span></label>
                            <label><input type="radio" name="increase_exercise" value="no"><span>No</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Does your pet receive Physical Rehabilitation Therapy?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="receives_rehab" value="yes" onclick="document.getElementById('rehab_details').style.display='block'"><span>Yes</span></label>
                            <label><input type="radio" name="receives_rehab" value="no" onclick="document.getElementById('rehab_details').style.display='none'"><span>No</span></label>
                        </div>
                        <div id="rehab_details" style="display:none; margin-top:12px;">
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="rehab_therapies" value="exercise_based"><span>Exercise based therapies</span></label>
                                <label><input type="checkbox" name="rehab_therapies" value="hydrotherapy"><span>Hydrotherapy</span></label>
                                <label><input type="checkbox" name="rehab_therapies" value="massage"><span>Massage Therapy</span></label>
                                <label><input type="checkbox" name="rehab_therapies" value="electro_thermo"><span>Electro and Thermotherapy (Cryotherapy, heat, laser, ultrasound, NMES, TENS)</span></label>
                                <label><input type="checkbox" name="rehab_therapies" value="assistive_devices"><span>Assistive and Supportive devices (Orthotics, prosthetics, wheelchairs etc.)</span></label>
                                <label><input type="checkbox" name="rehab_therapies" value="alternate"><span>Alternate therapy (Acupuncture/Chiropractic/Shockwave)</span></label>
                                <label><input type="checkbox" name="rehab_therapies" value="home_exercise"><span>Home exercise plans</span></label>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation for Step 6 -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(5)">← Previous</button>
                        <button type="button" class="btn-next" onclick="nextStep(7)">Next: Medical →</button>
                    </div>
                </div>

                <!-- Step 7: Medical History -->
                <div class="form-step" id="step-7">
                    <h2 class="section-title">Medical History</h2>
                    
                    <div class="form-group">
                        <label>Has your pet experienced involuntary weight changes recently?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="medical_weight_change" value="yes" onclick="document.getElementById('weight_change_details').style.display='block'">
                                <span>Yes</span>
                            </label>
                            <label>
                                <input type="radio" name="medical_weight_change" value="no" onclick="document.getElementById('weight_change_details').style.display='none'">
                                <span>No</span>
                            </label>
                        </div>
                        <div id="weight_change_details" style="display:none; margin-top:12px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                <div>
                                    <label style="font-size:0.85rem;">Type</label>
                                    <select name="medical_weight_type" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                        <option value="">Select...</option>
                                        <option value="gain">Weight gain</option>
                                        <option value="loss">Weight loss</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:0.85rem;">Amount (kg)</label>
                                    <input type="number" step="0.1" name="medical_weight_amount" placeholder="e.g., 2.5" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem;">Time period</label>
                                    <input type="text" name="medical_weight_period" placeholder="e.g., last 2 months" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Check any symptoms your pet is experiencing: <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="medical_symptoms" value="difficulty_chewing"><span>Difficulty chewing</span></label>
                            <label><input type="checkbox" name="medical_symptoms" value="difficulty_swallowing"><span>Difficulty swallowing</span></label>
                            <label><input type="checkbox" name="medical_symptoms" value="excessive_salivation"><span>Excessive salivation</span></label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Is your pet vomiting?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="medical_vomiting" value="yes" onclick="document.getElementById('vomiting_details').style.display='block'">
                                <span>Yes</span>
                            </label>
                            <label>
                                <input type="radio" name="medical_vomiting" value="no" onclick="document.getElementById('vomiting_details').style.display='none'">
                                <span>No</span>
                            </label>
                        </div>
                        <div id="vomiting_details" style="display:none; margin-top:12px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                <div>
                                    <label style="font-size:0.85rem;">Times per day</label>
                                    <input type="number" name="medical_vomit_per_day" placeholder="e.g., 2" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem;">Vomit colour</label>
                                    <input type="text" name="medical_vomit_colour" placeholder="e.g., yellow" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem;">Since when</label>
                                    <input type="text" name="medical_vomit_since" placeholder="e.g., 1 week" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Has urination changed?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="medical_urination_changed" value="yes" onclick="document.getElementById('urination_details').style.display='block'">
                                <span>Yes</span>
                            </label>
                            <label>
                                <input type="radio" name="medical_urination_changed" value="no" onclick="document.getElementById('urination_details').style.display='none'">
                                <span>No</span>
                            </label>
                        </div>
                        <div id="urination_details" style="display:none; margin-top:12px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div>
                                    <label style="font-size:0.85rem;">Change</label>
                                    <select name="medical_urination_direction" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                        <option value="">Select...</option>
                                        <option value="increased">Increased</option>
                                        <option value="decreased">Decreased</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:0.85rem;">Urine colour (if changed)</label>
                                    <input type="text" name="medical_urine_colour" placeholder="e.g., dark yellow" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Has drinking changed?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="medical_drinking_changed" value="yes" onclick="document.getElementById('drinking_details').style.display='block'">
                                <span>Yes</span>
                            </label>
                            <label>
                                <input type="radio" name="medical_drinking_changed" value="no" onclick="document.getElementById('drinking_details').style.display='none'">
                                <span>No</span>
                            </label>
                        </div>
                        <div id="drinking_details" style="display:none; margin-top:12px;">
                            <select name="medical_drinking_direction" style="width:100%; max-width:300px; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                <option value="">Select...</option>
                                <option value="increased">Increased</option>
                                <option value="decreased">Decreased</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Has stool quality changed?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="medical_stool_changed" value="yes" onclick="document.getElementById('stool_details').style.display='block'">
                                <span>Yes</span>
                            </label>
                            <label>
                                <input type="radio" name="medical_stool_changed" value="no" onclick="document.getElementById('stool_details').style.display='none'">
                                <span>No</span>
                            </label>
                        </div>
                        <div id="stool_details" style="display:none; margin-top:12px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div>
                                    <label style="font-size:0.85rem;">Stool colour</label>
                                    <input type="text" name="medical_stool_colour" placeholder="e.g., dark brown" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem;">Poops per day</label>
                                    <input type="number" name="medical_poops_per_day" placeholder="e.g., 2" style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px;">
                                </div>
                            </div>
                            <label style="font-size:0.85rem; display:block; margin-bottom:8px;">Stool type:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="medical_stool_types" value="hard"><span>Hard</span></label>
                                <label><input type="checkbox" name="medical_stool_types" value="soft"><span>Soft</span></label>
                                <label><input type="checkbox" name="medical_stool_types" value="loose"><span>Loose</span></label>
                                <label><input type="checkbox" name="medical_stool_types" value="blood"><span>Contains blood</span></label>
                                <label><input type="checkbox" name="medical_stool_types" value="mucus"><span>Contains mucus</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Q40: Medication Administration -->
                    <h2 class="section-title" style="margin-top: 30px;">Medication Administration</h2>
                    <div class="form-group">
                        <label>How do you administer pills/medications/supplements to your pet? <span style="font-size:0.85rem;color:#888;">(select all that apply)</span></label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="medication_admin" value="none_orally"><span>I do not give any medications/supplements/pills to my pet orally</span></label>
                            <label><input type="checkbox" name="medication_admin" value="directly_mouth"><span>I put them directly in my pet's mouth without food</span></label>
                            <label><input type="checkbox" name="medication_admin" value="in_food"><span>I put them in my pet's food</span></label>
                            <label><input type="checkbox" name="medication_admin" value="pill_pocket"><span>I put them in a Pill Pocket</span></label>
                            <label><input type="checkbox" name="medication_admin" value="in_treats"><span>I put them in foods/treats</span></label>
                        </div>
                        <input type="text" name="pill_pocket_details" placeholder="Pill Pocket: Product name, size, number..." style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px; margin-top:8px;">
                        <input type="text" name="med_food_treat_details" placeholder="Foods/treats used: list item(s) and amounts..." style="width:100%; padding:10px; border:1.5px solid #D9D4CC; border-radius:8px; margin-top:8px;">
                    </div>

                    <!-- Q41: Adverse Reactions (dynamic table) -->
                    <h2 class="section-title" style="margin-top: 30px;">Adverse Reactions</h2>
                    <div class="form-group">
                        <label>Does your pet have any specific adverse reactions to foods/medication?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="has_adverse_reactions" value="yes" onclick="document.getElementById('adverse_reactions_div').style.display='block'"><span>Yes</span></label>
                            <label><input type="radio" name="has_adverse_reactions" value="no" onclick="document.getElementById('adverse_reactions_div').style.display='none'"><span>No</span></label>
                        </div>
                        <div id="adverse_reactions_div" style="display:none; margin-top:16px;">
                            <div id="ar-table-container">
                                <div class="ar-entry" style="background:#FFF0F0; border:1.5px solid #E8B0B0; border-radius:10px; padding:16px; margin-bottom:12px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                        <strong style="color:#A02020;">Reaction #1</strong>
                                        <button type="button" onclick="this.closest('.ar-entry').remove()" style="background:#C0392B; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">Remove</button>
                                    </div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                        <div><label style="font-size:0.85rem;">Brand</label><input type="text" name="ar_brand[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                        <div><label style="font-size:0.85rem;">Product/Food Ingredient/Medication</label><input type="text" name="ar_product[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                        <div><label style="font-size:0.85rem;">Form/Type</label><input type="text" name="ar_form[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                        <div><label style="font-size:0.85rem;">Fed Since</label><input type="text" name="ar_since[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px;"></div>
                                        <div style="grid-column:span 2;"><label style="font-size:0.85rem;">Details of reaction/Symptoms</label><textarea name="ar_symptoms[]" style="width:100%; padding:8px; border:1.5px solid #D9D4CC; border-radius:8px; min-height:60px;"></textarea></div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="addAdverseReactionRow()" style="background:none; border:1.5px dashed #A02020; color:#A02020; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; width:100%;">+ Add Another Reaction</button>
                        </div>
                    </div>

                    <!-- Q43: Chronic Conditions -->
                    <h2 class="section-title" style="margin-top: 30px;">Chronic Conditions</h2>
                    <div class="form-group">
                        <label>Has your pet been diagnosed with any chronic condition(s)?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="has_chronic_condition" value="yes" onclick="document.getElementById('chronic_details_div').style.display='block'"><span>Yes</span></label>
                            <label><input type="radio" name="has_chronic_condition" value="no" onclick="document.getElementById('chronic_details_div').style.display='none'"><span>No</span></label>
                        </div>
                        <div id="chronic_details_div" style="display:none; margin-top:12px;">
                            <textarea name="chronic_condition_details" placeholder="Please specify chronic conditions..." style="width:100%; padding:12px; border:1.5px solid #D9D4CC; border-radius:8px; min-height:80px;"></textarea>
                        </div>
                    </div>

                    <!-- Navigation for Step 7 -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(6)">← Previous</button>
                        <button type="button" class="btn-next" onclick="nextStep(8)">Next: Vaccination →</button>
                    </div>
                </div>

                <!-- Step 8: Vaccination & Primary Vet -->
                <div class="form-step" id="step-8">
                    <h2 class="section-title">Vaccination & Prevention Status</h2>
                    
                    <div class="form-group">
                        <label>Yearly vaccinations up to date?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="vacc_yearly" value="yes"><span>Yes</span></label>
                            <label><input type="radio" name="vacc_yearly" value="no"><span>No</span></label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Deworming every 3 months?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="vacc_deworming" value="yes"><span>Yes</span></label>
                            <label><input type="radio" name="vacc_deworming" value="no"><span>No</span></label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Topical tick/flea spot-on treatment:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="vacc_topical_tick" value="monthly"><span>Every month</span></label>
                            <label><input type="radio" name="vacc_topical_tick" value="3monthly"><span>Every 3 months</span></label>
                            <label><input type="radio" name="vacc_topical_tick" value="no"><span>No</span></label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Oral tick/flea preventive:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="vacc_oral_tick" value="monthly"><span>Every month</span></label>
                            <label><input type="radio" name="vacc_oral_tick" value="6monthly"><span>Every 6 months</span></label>
                            <label><input type="radio" name="vacc_oral_tick" value="no"><span>No</span></label>
                        </div>
                    </div>
                    
                    <h2 class="section-title" style="margin-top:40px;">Primary Veterinarian Information</h2>
                    
                    <div class="form-group">
                        <label>Veterinarian Name <span class="required">*</span></label>
                        <input type="text" name="vet_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Practice Name / Location <span class="required">*</span></label>
                        <input type="text" name="vet_practice" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Clinic Phone <span class="required">*</span></label>
                        <input type="tel" name="vet_phone" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Clinic Email <span class="required">*</span></label>
                        <input type="email" name="vet_email" required>
                    </div>
                    
                    <!-- Navigation for Step 8 -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(7)">← Previous</button>
                        <button type="button" class="btn-next" onclick="nextStep(9)">Next: Consent →</button>
                    </div>
                </div>

                <!-- Step 9: Consent Form -->
                <div class="form-step" id="step-9">
                    <h2 class="section-title">Consultation Consent Form</h2>
                    
                    <div style="background:#FFFBF5; border:1.5px solid #E8D5B0; border-radius:12px; padding:24px; margin-bottom:24px; max-height:500px; overflow-y:auto;">
                        <h3 style="color:#8B6914; font-size:1.1rem; margin-bottom:16px;">Consent for In-Person/Remote Clinical Nutrition Consultations</h3>
                        <div style="font-size:0.85rem; line-height:1.7; color:#2C2C2C; text-align:justify;">
                            <p style="margin-bottom:12px;"><strong>1. Owner Authorization:</strong> I, the undersigned, do hereby certify that I am the owner (or authorized agent of the owner) of this animal and that I am 18 years of age or older; and have the authorization to consent to treatment if and when it is needed.</p>
                            
                            <p style="margin-bottom:12px;"><strong>2. Treatment Authorization:</strong> I hereby authorize Poshtik Nutrivet, their doctors(s), to recommend/advise the medical or surgical procedures, sedation, anesthesia, x-ray examination, diagnostic procedures, prescribe drugs, or such treatment which the clinician deems necessary.</p>
                            
                            <p style="margin-bottom:12px;"><strong>3. No Guarantee Acknowledgment:</strong> I understand that the practice of veterinary medicine and surgery is not an exact science, and I acknowledge that no guarantees have been made to me as to the result of treatments and examination. By signing this agreement, I authorize Poshtik Nutivet's doctor(s) and staff to provide clinical nutritional care they consider reasonable and necessary for my animal, and I consent to any such services. I understand that with any medical recommendation there are always risks involved, including death, and that no warranty or guarantee is being made as to the results or cure.</p>
                            
                            <p style="margin-bottom:12px;"><strong>4. Primary Care Coordination:</strong> I am aware that Poshtik Nutrivet is committed to working with my primary care/referring veterinarian and providing the best care available to my pet. I understand that Dr. Eunice Thomas will only treat my pet for the condition or for the problems associated with my pet's nutritional needs. I also understand that my pet's medical records will be sent to my primary care/referring veterinarian. I agree to the acknowledgement and disclosure stated above, based on my choice of consultation.</p>
                            
                            <p style="margin-bottom:12px;"><strong>5. Consultation Method Preference:</strong> I am aware and acknowledge that any consultation for my pet is most preferred as an in-person consult in which the veterinary nutritionist can physically examine my pet. I am aware that only video or phone consults for my pet is not a preferred method to get the best possible clinical outcome for my pet. I am still willing to opt for an online video/phone consult fully aware of possible failure(s) and an unacceptable outcome in my pet's treatment at my own risk.</p>
                            
                            <p style="margin-bottom:12px;"><strong>6. Educational Activities:</strong> I understand and agree that Poshtik Nutrivet is involved in educational activities and that faculty, residents, interns and students will be involved in my animal's care.</p>
                            
                            <p style="margin-bottom:12px;"><strong>7. Release of Information:</strong> I authorize the release of medical information to the concerned Insurance Company, their agents or representatives in order to process any claims or applications for insurance. I further authorize the release of medical information to my Primary Veterinarian. I will return to my primary care veterinarian for all routine veterinary care.</p>
                            
                            <p style="margin-bottom:12px;"><strong>8. Liability Release:</strong> By signing this form, I hereby declare my understanding and accept the guidelines set forth in the care for my pet. I am fully releasing the veterinarian(s) and staff from any liability or damages, should any occur during the period of assessment, treatment and care of my pet.</p>
                            
                            <p style="margin-bottom:12px;"><strong>9. Photography/Videos/Audio:</strong> If I submit photographs/video/audio recordings of my animal, I hereby authorize Poshtik Nutrivet to take and use or permit other persons assigned to use the images, videos, or sound recordings prepared therefrom for such purposes and in such manner as may be deemed necessary, including but not limited to use on their website, social media platforms, for promotional, educational, research or public informational purposes related to their services and the animal and/or owner will not be identified by name. I understand that no compensation will be provided for the use of these images/videos and that Poshtik Nutrivet/Dr Eunice Thomas may use them without further notice to me.</p>
                            
                            <p style="margin-bottom:12px;"><strong>10. Defamation:</strong> I agree that circulation of defamatory comments about the Veterinarian/Poshtik Nutrivet on any social media platform(s)/WhatsApp group(s) amounts to the offence of defamation, warranting the Veterinarian to take legal action.</p>
                            
                            <p style="margin-bottom:12px;"><strong>11. Payment Terms:</strong> I agree to accept responsibility for the payment of all consultations/services rendered. I understand that the professional services are to be paid at the time of booking of appointment. I understand that I will be financially responsible for all the services provided by Poshtik Nutrivet, including all nutrition plan(s) provided to me for my pet at in-person consults or over the phone/online consult(s). Should it become necessary to collect this account through an attorney, the undersigned agrees to pay all costs of collections, including reasonable attorney fee, payment required when services rendered, service charge levied for all returned checks, interest may be charged at a rate of 1.5% per month (10% per annum) for all accounts with outstanding balances.</p>
                            
                            <p style="margin-bottom:12px;"><strong>12. Understanding and Acceptance:</strong> The undersigned certifies that he/she has read the foregoing or has had the foregoing read to him/her, and that he/she understands and fully accepts its terms.</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div style="background:#F5F8F5; border:1.5px solid #7A9E7E; border-radius:10px; padding:20px;">
                            <label style="display:flex; align-items:flex-start; gap:12px; cursor:pointer; margin-bottom:0;">
                                <input type="checkbox" name="consent_agreed" value="yes" required style="width:20px; height:20px; margin-top:2px; flex-shrink:0;">
                                <span style="font-size:0.9rem; line-height:1.5;">
                                    <strong>I have read and agree to the above terms and conditions.</strong><br>
                                    <span style="color:#6B6B6B; font-size:0.8rem;">By checking this box, you are providing your digital consent to proceed with the consultation.</span>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Full Name (for consent) <span class="required">*</span></label>
                        <input type="text" name="consent_name" required placeholder="Type your full name to confirm">
                    </div>
                    
                    <div style="background:#E8F4F8; border:1px solid #B8D4E8; border-radius:10px; padding:16px; margin:24px 0;">
                        <p style="font-size:0.85rem; color:#2C2C2C; margin-bottom:8px;"><strong>📋 Important Reminders:</strong></p>
                        <ul style="font-size:0.82rem; color:#6B6B6B; margin-left:20px; line-height:1.6;">
                            <li>Blood reports (CBC, biochemistry) must be from Veterinary Diagnostic Laboratories only</li>
                            <li>Blood test reports are valid for 1 month</li>
                            <li>Stool and urine reports are valid for 7 days only</li>
                            <li>You will receive a confirmation email with your Case ID after submission</li>
                        </ul>
                    </div>
                    
                    <!-- Final Navigation -->
                    <div class="form-navigation">
                        <button type="button" class="btn-prev" onclick="prevStep(8)">← Previous</button>
                        <div style="display:flex; gap:10px;">
                            <button type="button" class="btn-prev" onclick="submitForm('save_draft')">Save Draft</button>
                            <button type="button" class="btn-next" onclick="submitForm('submit')">Submit Form</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    </main>
    </div>
    <button type="button" class="save-draft-fab" onclick="submitForm('save_draft')">Save Draft</button>
    {{ prefill_payload|json_script:"intake-prefill-data" }}
    {{ draft_payload|json_script:"intake-draft-data" }}
    <script>
    (function() {
        var prefill = {};
        var draft = {};
        try {
            prefill = JSON.parse(document.getElementById("intake-prefill-data").textContent || "{}");
        } catch (e) {
            prefill = {};
        }
        try {
            draft = JSON.parse(document.getElementById("intake-draft-data").textContent || "{}");
        } catch (e) {
            draft = {};
        }

        function qsaByName(name) {
            return document.querySelectorAll('[name="' + name.replace(/"/g, '\\"') + '"]');
        }

        function applyPayload(payload) {
            Object.keys(payload).forEach(function(name) {
                if (name === "action" || name === "current_step") return;
                var values = Array.isArray(payload[name]) ? payload[name] : [payload[name]];
                var controls = qsaByName(name);
                if (!controls.length) return;

                var first = controls[0];
                if (first.type === "radio") {
                    controls.forEach(function(ctrl) {
                        ctrl.checked = values.indexOf(ctrl.value) !== -1;
                        ctrl.dispatchEvent(new Event("change", { bubbles: true }));
                    });
                    return;
                }

                if (first.type === "checkbox") {
                    controls.forEach(function(ctrl) {
                        ctrl.checked = values.indexOf(ctrl.value) !== -1 || values.indexOf("on") !== -1;
                        ctrl.dispatchEvent(new Event("change", { bubbles: true }));
                    });
                    return;
                }

                controls.forEach(function(ctrl, idx) {
                    ctrl.value = values[idx] !== undefined ? values[idx] : "";
                    ctrl.dispatchEvent(new Event("input", { bubbles: true }));
                    ctrl.dispatchEvent(new Event("change", { bubbles: true }));
                });
            });
        }

        applyPayload(prefill);
        applyPayload(draft);

        var step = parseInt(draft.current_step || "1", 10);
        if (!isNaN(step) && step > 1 && typeof goToStepDirect === "function") {
            goToStepDirect(step);
        }

        document.querySelectorAll('.step').forEach(function(stepEl) {
            stepEl.setAttribute('role', 'button');
            stepEl.setAttribute('tabindex', '0');
            stepEl.setAttribute('aria-label', 'Go to ' + (stepEl.querySelector('.step-label')?.textContent || 'step'));
            stepEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    var targetStep = parseInt(stepEl.getAttribute('data-step'), 10);
                    if (!isNaN(targetStep) && typeof goToStep === 'function') goToStep(targetStep);
                }
            });
        });

        var form = document.getElementById('dietHistoryForm');
        var autosaveTimer = null;
        var autosaveIndicator = document.getElementById('autosave-indicator');
        var autosaveText = document.getElementById('autosave-text');
        var autosaveToast = document.createElement('div');
        autosaveToast.style.cssText = 'position:fixed;right:14px;bottom:14px;background:#edf8f3;border:1px solid #c9d9d2;color:#205940;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999';
        autosaveToast.textContent = 'Draft autosaved';
        document.body.appendChild(autosaveToast);

        function autosaveNow() {
            autosaveIndicator.classList.add('saving');
            autosaveIndicator.classList.remove('error');
            autosaveText.textContent = 'Saving draft...';
            var fd = new FormData(form);
            fd.set('action', 'autosave');
            fetch(window.location.href, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: fd
            }).then(function(resp) {
                if (!resp.ok) return;
                return resp.json();
            }).then(function(data) {
                autosaveToast.style.display = 'block';
                setTimeout(function(){ autosaveToast.style.display = 'none'; }, 1200);
                autosaveIndicator.classList.remove('saving', 'error');
                if (data && data.saved_at) {
                    var dt = new Date(data.saved_at);
                    autosaveText.textContent = 'Last saved at ' + dt.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                } else {
                    autosaveText.textContent = 'Draft saved';
                }
            }).catch(function(){
                autosaveIndicator.classList.remove('saving');
                autosaveIndicator.classList.add('error');
                autosaveText.textContent = 'Autosave failed. Retrying on next change.';
            });
        }

        function queueAutosave() {
            if (autosaveTimer) clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(autosaveNow, 900);
        }

        form.addEventListener('input', queueAutosave);
        form.addEventListener('change', queueAutosave);
    })();
    </script>
</body>
</html>
