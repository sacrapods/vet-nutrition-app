{% load static intake_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ pet.name }} — {{ pet.owner.case_id }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'design_system/tokens.css' %}?v=20260221">
    <style>
        html, body { margin: 0; padding: 0; font-family: 'Manrope', system-ui, sans-serif; }

        /* ── Detail wrapper ──────────────────────────── */
        .detail-wrap { max-width: 860px; }

        /* ── Alert ───────────────────────────────────── */
        .cd-alert {
            background: var(--ds-ok-bg);
            border: 1px solid var(--ds-ok-border);
            color: var(--ds-ok);
            padding: 11px 15px;
            border-radius: var(--ds-radius-sm);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* ── Pet hero header ─────────────────────────── */
        .cd-header {
            background: linear-gradient(128deg, #0e3323 0%, #1a5c3a 50%, #2a7a52 100%);
            border-radius: var(--ds-radius-lg);
            padding: 24px 28px 22px;
            color: #fff;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--ds-shadow-lg);
        }
        .cd-header::before {
            content: '';
            position: absolute;
            top: -40px; right: -40px;
            width: 160px; height: 160px;
            border-radius: 50%;
            background: rgba(255,255,255,.04);
            pointer-events: none;
        }
        .cd-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .cd-header h1 {
            font-size: 1.55rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin: 0 0 4px;
            line-height: 1.2;
        }
        .cd-header-meta {
            font-size: 13px;
            color: rgba(255,255,255,.78);
            line-height: 1.5;
        }
        .cd-case-badge {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            background: rgba(255,255,255,.18);
            border: 1px solid rgba(255,255,255,.22);
            padding: 4px 13px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* ── Action bar ──────────────────────────────── */
        .cd-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .cd-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            border: 1.5px solid var(--ds-line-2);
            background: var(--ds-panel);
            color: var(--ds-text-2);
            padding: 8px 16px;
            border-radius: var(--ds-radius-sm);
            font-size: 13px;
            font-weight: 700;
            transition: background .12s, border-color .12s, color .12s;
            white-space: nowrap;
            cursor: pointer;
        }
        .cd-btn:hover { background: var(--ds-panel-2); border-color: var(--ds-muted-2); color: var(--ds-text); }
        .cd-btn svg { stroke: currentColor; fill: none; flex-shrink: 0; }
        .cd-btn.accent {
            background: var(--ds-accent-3);
            border-color: rgba(11,83,148,.22);
            color: var(--ds-accent);
        }
        .cd-btn.accent:hover { background: #d5e7f9; border-color: var(--ds-accent); }
        .cd-btn.back {
            background: var(--ds-panel-2);
            color: var(--ds-muted);
        }
        .cd-btn.back:hover { background: var(--ds-line); color: var(--ds-text-2); }

        /* ── Vet link share card ─────────────────────── */
        .share-card {
            background: var(--ds-panel);
            border: 1px solid var(--ds-line);
            border-radius: var(--ds-radius);
            box-shadow: var(--ds-shadow-sm);
            margin-bottom: 12px;
            overflow: hidden;
        }
        .share-card-head {
            padding: 14px 18px;
            border-bottom: 1px solid var(--ds-line);
            font-size: 13px;
            font-weight: 700;
            color: var(--ds-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .share-card-body { padding: 16px 18px; }
        .share-card-body p { font-size: 13px; color: var(--ds-muted); margin: 0 0 12px; }
        .share-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .share-input {
            flex: 1;
            min-width: 220px;
            padding: 9px 12px;
            border: 1.5px solid var(--ds-line-2);
            border-radius: var(--ds-radius-sm);
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size: 12px;
            background: var(--ds-panel-2);
            color: var(--ds-text);
            outline: none;
        }
        .share-btn {
            padding: 9px 16px;
            border: none;
            border-radius: var(--ds-radius-sm);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: background .12s;
        }
        .share-btn.copy { background: var(--ds-accent); color: #fff; }
        .share-btn.copy:hover { background: var(--ds-accent-2); }
        .share-btn.regen { background: var(--ds-panel-2); color: var(--ds-text-2); border: 1.5px solid var(--ds-line-2); }
        .share-btn.regen:hover { background: var(--ds-line); }
        .share-btn.generate { background: var(--ds-accent); color: #fff; }
        .share-btn.generate:hover { background: var(--ds-accent-2); }

        /* ── Collapsible sections ────────────────────── */
        .cd-section {
            background: var(--ds-panel);
            border: 1px solid var(--ds-line);
            border-radius: var(--ds-radius);
            box-shadow: var(--ds-shadow-sm);
            margin-bottom: 10px;
            overflow: hidden;
        }
        .cd-section-head {
            padding: 14px 18px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 700;
            color: var(--ds-text);
            background: var(--ds-panel);
            user-select: none;
            transition: background .12s;
        }
        .cd-section-head:hover { background: var(--ds-panel-2); }
        .cd-section.open .cd-section-head { border-bottom: 1px solid var(--ds-line); }
        .cd-chevron {
            width: 16px; height: 16px;
            stroke: var(--ds-muted);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform .2s;
            flex-shrink: 0;
        }
        .cd-section.open .cd-chevron { transform: rotate(180deg); }
        .cd-section-body { display: none; padding: 18px 20px; overflow: auto; }
        .cd-section.open .cd-section-body { display: block; }

        /* ── Fields ──────────────────────────────────── */
        .field {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid var(--ds-line);
            font-size: 13.5px;
        }
        .field:last-child { border: none; }
        .field-label {
            width: 200px;
            flex-shrink: 0;
            color: var(--ds-muted);
            font-size: 12.5px;
            font-weight: 600;
            padding-right: 12px;
            line-height: 1.5;
        }
        .field-value { flex: 1; color: var(--ds-text); line-height: 1.5; }

        /* ── Sub-tables ──────────────────────────────── */
        .sub-head {
            font-size: 11.5px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--ds-brand);
            margin: 18px 0 8px;
        }
        .sub-head:first-child { margin-top: 0; }
        .sub-head.warn { color: var(--ds-warn); }
        .table-wrap { overflow: auto; -webkit-overflow-scrolling: touch; margin-bottom: 4px; }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 560px;
            font-size: 13px;
        }
        table th {
            text-align: left;
            padding: 9px 11px;
            background: var(--ds-panel-2);
            font-size: 10.5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--ds-muted);
            border-bottom: 1px solid var(--ds-line);
        }
        table td {
            padding: 9px 11px;
            border-bottom: 1px solid var(--ds-line);
            color: var(--ds-text-2);
            vertical-align: top;
        }
        table tbody tr:last-child td { border-bottom: none; }
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 11.5px;
            background: var(--ds-brand-3);
            color: var(--ds-brand);
            margin: 2px;
            font-weight: 600;
        }
        .empty-msg { color: var(--ds-muted-2); font-style: italic; font-size: 13px; }

        /* ── Responsive ──────────────────────────────── */
        @media (max-width: 760px) {
            .cd-header { padding: 18px 18px 16px; border-radius: var(--ds-radius); }
            .cd-header h1 { font-size: 1.2rem; }
            .field { flex-direction: column; gap: 2px; }
            .field-label { width: 100%; font-size: 11.5px; }
            .cd-actions { flex-wrap: wrap; }
            .cd-btn { flex: 1 1 auto; justify-content: center; }
        }
    </style>
</head>
<body>
<a class="skip-link" href="#main-content">Skip to main content</a>
<div class="app-shell">

    <!-- Sidebar -->
    <aside class="app-sidebar" aria-label="Primary navigation">
        <div class="brand">POSHTIK NUTRIVET</div>
        <div class="brand-sub">Pet Parent Portal</div>
        <nav>
            <div class="nav-section">My Account</div>
            <a href="{% url 'submission_history' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Dashboard
            </a>
            <a href="{% url 'appointments:pet_dashboard' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M8 3v4M16 3v4M3 10h18"/></svg>
                Appointments
            </a>
            <div class="nav-section">Forms</div>
            <a href="{% url 'intake_form' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/><path d="M9 12h6M9 16h4"/></svg>
                Intake Form
            </a>
            <a href="{% url 'homemade_diet_questionnaire' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10-4.5 10-10 10z"/><path d="M12 8v4l3 3"/></svg>
                Homemade Form
            </a>
        </nav>
        <div class="sidebar-footer">
            <a href="{% url 'logout' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M10 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h4"/><path d="M14 8l4 4-4 4M18 12H9"/></svg>
                Logout
            </a>
        </div>
    </aside>

    <!-- Main -->
    <main id="main-content" class="app-main">
        <div class="detail-wrap">

            {% if messages %}
                {% for message in messages %}
                    <div class="cd-alert">{{ message }}</div>
                {% endfor %}
            {% endif %}

            <!-- Pet hero header -->
            <div class="cd-header">
                <div class="cd-header-top">
                    <div>
                        <h1>{{ pet.name }} <span style="font-size:1rem;font-weight:600;opacity:.7">({{ pet.get_species_display }})</span></h1>
                        <div class="cd-header-meta">
                            Owner: {{ pet.owner.name }} &middot; {{ pet.breed }} &middot; {{ pet.dob_age }} &middot; {{ pet.get_sex_display }}{% if pet.neutered %} (Neutered){% endif %} &middot; {% if pet.current_weight_kg %}{{ pet.current_weight_kg }} kg{% else %}Weight not provided{% endif %}
                        </div>
                    </div>
                    <span class="cd-case-badge">{{ pet.owner.case_id }}</span>
                </div>
            </div>

            <!-- Action bar -->
            <div class="cd-actions">
                <a class="cd-btn back" href="{% url back_url_name %}">
                    <svg viewBox="0 0 24 24" width="14" height="14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
                    Back
                </a>
                <a class="cd-btn" href="{% url 'case_pdf' pet.pk %}">
                    <svg viewBox="0 0 24 24" width="14" height="14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                    Print View
                </a>
                {% if show_vet_link %}
                <a class="cd-btn accent" href="{% url 'pet_admin_portal:profile_hub' pet.owner.id %}?pet={{ pet.id }}">
                    <svg viewBox="0 0 24 24" width="14" height="14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    EMR Hub
                </a>
                <a class="cd-btn accent" href="{% url 'vet_form' pet.pk %}">
                    <svg viewBox="0 0 24 24" width="14" height="14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/><path d="M9 12h6M9 16h4"/></svg>
                    Vet Form
                </a>
                {% endif %}
            </div>

            <!-- Vet public link share -->
            {% if show_vet_share %}
            <div class="share-card">
                <div class="share-card-head">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="15" height="15"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Primary Veterinarian Form Link
                </div>
                <div class="share-card-body">
                    <p>Share this only with your primary veterinarian. It opens the vet clinical form for this specific pet.</p>
                    {% if vet_public_url %}
                    <div class="share-row">
                        <input id="vet-public-link" class="share-input" type="text" value="{{ vet_public_url }}" readonly>
                        <button class="share-btn copy" type="button" onclick="navigator.clipboard.writeText(document.getElementById('vet-public-link').value)">Copy Link</button>
                        <form method="post" action="{% url 'generate_vet_link' pet.pk %}" style="margin:0">
                            {% csrf_token %}
                            <input type="hidden" name="rotate" value="1">
                            <button class="share-btn regen" type="submit">Regenerate</button>
                        </form>
                    </div>
                    {% else %}
                    <form method="post" action="{% url 'generate_vet_link' pet.pk %}" style="margin:0">
                        {% csrf_token %}
                        <button class="share-btn generate" type="submit">Generate Vet Link</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 1. Owner & Pet -->
            <div class="cd-section open">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>1. Owner &amp; Pet Info</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    <div class="field"><span class="field-label">Owner Name</span><span class="field-value">{{ pet.owner.name }}</span></div>
                    <div class="field"><span class="field-label">Email</span><span class="field-value">{{ pet.owner.email }}</span></div>
                    <div class="field"><span class="field-label">Phone</span><span class="field-value">{{ pet.owner.phone }}</span></div>
                    <div class="field"><span class="field-label">Location</span><span class="field-value">{{ pet.owner.location_primary_vet|default:"-" }}</span></div>
                    <div class="field"><span class="field-label">Body Condition</span><span class="field-value">{{ pet.get_body_condition_display }}</span></div>
                    <div class="field"><span class="field-label">Consultation Goals</span><span class="field-value">{{ pet.consultation_goals }}</span></div>
                </div>
            </div>

            <!-- 2. Household -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>2. Household Details</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% with h=pet.household %}
                    {% if h %}
                    <div class="field"><span class="field-label">Food/Ingredients to Avoid</span><span class="field-value">{{ h.food_ingredients_to_avoid|default:"-" }}</span></div>
                    <div class="field"><span class="field-label">Can Arrange Special Food</span><span class="field-value">{{ h.can_arrange_special_food }}</span></div>
                    <div class="field"><span class="field-label">Who Feeds</span><span class="field-value">{{ h.who_feeds|pretty_token }}{% if h.feeder_name %} ({{ h.feeder_name }}){% endif %}</span></div>
                    <div class="field"><span class="field-label">Other Pets</span><span class="field-value">{% if h.other_pets %}Yes — {{ h.other_pets_details }}{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Pet Housed</span><span class="field-value">{{ h.pet_housed|pretty_token }}</span></div>
                    {% else %}<p class="empty-msg">No household data</p>{% endif %}
                    {% endwith %}
                </div>
            </div>

            <!-- 3. Feeding -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>3. Feeding Behavior</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% with f=pet.feeding %}
                    {% if f %}
                    <div class="field"><span class="field-label">Food Availability</span><span class="field-value">{{ f.food_availability|pretty_token }}{% if f.food_availability_times %} ({{ f.food_availability_times }}){% endif %}</span></div>
                    <div class="field"><span class="field-label">Meals/Day</span><span class="field-value">{{ f.meals_per_day|default:"-" }}</span></div>
                    <div class="field"><span class="field-label">Eating Behaviors</span><span class="field-value">{{ f.eating_behaviors|pretty_csv }}</span></div>
                    <div class="field"><span class="field-label">Appetite</span><span class="field-value">{{ f.good_appetite|default:"-" }} / Recently: {{ f.appetite_recently|default:"-" }}</span></div>
                    <div class="field"><span class="field-label">Attitude Changed</span><span class="field-value">{% if f.attitude_changed %}Yes — {{ f.attitude_change_details }}{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Unmonitored Access</span><span class="field-value">{% if f.unmonitored_food_access %}Yes — {{ f.unmonitored_sources|pretty_csv }}{% else %}No{% endif %}</span></div>
                    {% else %}<p class="empty-msg">No feeding data</p>{% endif %}
                    {% endwith %}
                </div>
            </div>

            <!-- 4. Food Preferences -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>4. Food Preferences</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% with fp=pet.food_preferences %}
                    {% if fp %}
                    <div class="field"><span class="field-label">Food Preferences</span><span class="field-value">{{ fp.current_food_preferences|pretty_csv }}</span></div>
                    <div class="field"><span class="field-label">Treat Preferences</span><span class="field-value">{{ fp.current_treat_preferences|pretty_csv }}</span></div>
                    <div class="field"><span class="field-label">Refuses Food</span><span class="field-value">{% if fp.refuses_food %}Yes — {{ fp.refused_food_details }}{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Important Factors</span><span class="field-value">{{ fp.important_food_factors|pretty_csv }}</span></div>
                    {% else %}<p class="empty-msg">No preference data</p>{% endif %}
                    {% endwith %}
                    {% with tp=pet.treat_plan_preferences %}
                    {% if tp %}<div class="field"><span class="field-label">Treat Plan Preferences</span><span class="field-value">{{ tp.preferences|pretty_csv }}</span></div>{% endif %}
                    {% endwith %}
                    {% with a=pet.advice_source %}
                    {% if a %}<div class="field"><span class="field-label">Advice Sources</span><span class="field-value">{{ a.sources|pretty_csv }}{% if a.other_source %}, {{ a.other_source }}{% endif %}</span></div>{% endif %}
                    {% endwith %}
                    {% if pet.brands_to_avoid.exists %}
                    <div class="sub-head">Brands to Avoid</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Brand</th><th>Reason</th></tr></thead>
                        <tbody>{% for b in pet.brands_to_avoid.all %}<tr><td>{{ b.brand_name }}</td><td>{{ b.reason|default:"-" }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                </div>
            </div>

            <!-- 5. Diet History -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>5. Diet History</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% if pet.commercial_diet.exists %}
                    <div class="sub-head">Commercial Diet</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Type</th><th>Brand</th><th>Product</th><th>Amount/Day</th><th>Since</th></tr></thead>
                        <tbody>{% for d in pet.commercial_diet.all %}<tr><td>{{ d.diet_type }}</td><td>{{ d.brand }}</td><td>{{ d.product_details }}</td><td>{{ d.amount_per_day }}</td><td>{{ d.fed_since }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% if pet.homemade_diet.exists %}
                    <div class="sub-head">Homemade Diet</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Ingredient</th><th>Qty</th><th>Preparation</th><th>Freq/Day</th><th>Since</th></tr></thead>
                        <tbody>{% for d in pet.homemade_diet.all %}<tr><td>{{ d.ingredient_food_item }}</td><td>{{ d.raw_quantity_per_day }}</td><td>{{ d.preparation_method }}</td><td>{{ d.feed_frequency_per_day }}</td><td>{{ d.fed_since }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% if pet.commercial_treats.exists %}
                    <div class="sub-head">Commercial Treats</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Type</th><th>Brand</th><th>Product</th><th>Qty/Day</th><th>Since</th></tr></thead>
                        <tbody>{% for t in pet.commercial_treats.all %}<tr><td>{{ t.treat_type }}</td><td>{{ t.brand }}</td><td>{{ t.product_details }}</td><td>{{ t.quantity_per_day }}</td><td>{{ t.fed_since }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% if pet.homemade_treats.exists %}
                    <div class="sub-head">Homemade Treats</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Type/Form</th><th>Ingredient</th><th>Preparation</th><th>Qty/Day</th><th>Since</th></tr></thead>
                        <tbody>{% for t in pet.homemade_treats.all %}<tr><td>{{ t.treat_type_form }}</td><td>{{ t.ingredient }}</td><td>{{ t.preparation_method }}</td><td>{{ t.quantity_per_day }}</td><td>{{ t.fed_since }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% if pet.supplements.exists %}
                    <div class="sub-head">Supplements</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Brand</th><th>Form</th><th>Amount</th><th>Per Day</th><th>Since</th></tr></thead>
                        <tbody>{% for s in pet.supplements.all %}<tr><td>{{ s.brand_name }}</td><td>{{ s.form }}</td><td>{{ s.amount }}</td><td>{{ s.per_day }}</td><td>{{ s.fed_since }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% if pet.recent_diet_changes.exists %}
                    <div class="sub-head">Recent Diet Changes</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Brand</th><th>Product</th><th>Form</th><th>Amount</th><th>Start</th><th>Stop</th><th>Reason</th></tr></thead>
                        <tbody>{% for r in pet.recent_diet_changes.all %}<tr><td>{{ r.brand }}</td><td>{{ r.product_food_ingredient }}</td><td>{{ r.form_type }}</td><td>{{ r.amount_per_day }}</td><td>{{ r.start_date }}</td><td>{{ r.stop_date|default:"-" }}</td><td>{{ r.reason_stopped }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% with dp=pet.diet_preferences %}
                    {% if dp %}<div class="field" style="margin-top:12px"><span class="field-label">Diet Plan Preferences</span><span class="field-value">{{ dp.preferences|pretty_csv }}</span></div>{% endif %}
                    {% endwith %}
                    {% if pet.food_storage.exists %}
                    <div class="sub-head">Food Storage</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Food Type</th><th>Storage Location</th><th>Time Period</th></tr></thead>
                        <tbody>{% for fs in pet.food_storage.all %}<tr><td>{{ fs.food_type }}</td><td>{{ fs.storage_location }}</td><td>{{ fs.time_period }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                </div>
            </div>

            <!-- 6. Fitness -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>6. Fitness &amp; Activity</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% with fa=pet.fitness %}
                    {% if fa %}
                    <div class="field"><span class="field-label">Activity Level</span><span class="field-value">{{ fa.get_activity_level_display }}</span></div>
                    <div class="field"><span class="field-label">Exercise Duration</span><span class="field-value">{{ fa.exercise_duration|pretty_token }}</span></div>
                    <div class="field"><span class="field-label">Leash Walk Freq</span><span class="field-value">{{ fa.leash_walk_frequency|pretty_token }}</span></div>
                    <div class="field"><span class="field-label">Fenced Yard</span><span class="field-value">{% if fa.fenced_yard_access %}Yes{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Urban/Rural</span><span class="field-value">{{ fa.urban_rural|pretty_token }}</span></div>
                    <div class="field"><span class="field-label">Exercise Types</span><span class="field-value">{{ fa.exercise_types|pretty_csv }}</span></div>
                    <div class="field"><span class="field-label">Training/Show Dog</span><span class="field-value">{% if fa.training_show_dog %}Yes{% if fa.training_details %} — {{ fa.training_details }}{% endif %}{% else %}No{% endif %}</span></div>
                    {% else %}<p class="empty-msg">No fitness data</p>{% endif %}
                    {% endwith %}
                    {% if pet.activity_details.exists %}
                    <div class="sub-head">Activity Details</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Activity</th><th>Duration/Distance</th><th>Freq/Week</th></tr></thead>
                        <tbody>{% for a in pet.activity_details.all %}<tr><td>{{ a.get_activity_type_display }}</td><td>{{ a.duration_distance }}</td><td>{{ a.frequency_per_week }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% with r=pet.rehabilitation %}
                    {% if r %}<div class="field" style="margin-top:12px"><span class="field-label">Rehabilitation</span><span class="field-value">{% if r.receives_therapy %}Yes — {{ r.therapy_types|pretty_csv }}{% else %}No{% endif %}</span></div>{% endif %}
                    {% endwith %}
                </div>
            </div>

            <!-- 7. Medical -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>7. Medical History</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% with m=pet.medical_history %}
                    {% if m %}
                    <div class="field"><span class="field-label">Weight Change</span><span class="field-value">{% if m.weight_change %}{{ m.weight_change_type }} — {{ m.weight_change_amount_kg }}kg over {{ m.weight_change_period }}{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Chewing/Swallowing</span><span class="field-value">{% if m.difficulty_chewing %}Difficulty chewing{% endif %} {% if m.difficulty_swallowing %}Difficulty swallowing{% endif %} {% if m.excessive_salivation %}Excessive salivation{% endif %}{% if not m.difficulty_chewing and not m.difficulty_swallowing and not m.excessive_salivation %}None{% endif %}</span></div>
                    <div class="field"><span class="field-label">Vomiting</span><span class="field-value">{% if m.vomiting_per_day %}{{ m.vomiting_per_day }}/day{% endif %} {% if m.vomiting_per_week %}{{ m.vomiting_per_week }}/week{% endif %} {% if m.vomiting_colour %}colour: {{ m.vomiting_colour }}{% endif %} {% if m.vomiting_since %}since {{ m.vomiting_since }}{% endif %}{% if not m.vomiting_per_day and not m.vomiting_per_week %}None reported{% endif %}</span></div>
                    <div class="field"><span class="field-label">Urination</span><span class="field-value">{% if m.urination_changed %}Changed: {{ m.urination_direction }}{% if m.urine_colour %}, colour: {{ m.urine_colour }}{% endif %}{% else %}Normal{% endif %}</span></div>
                    <div class="field"><span class="field-label">Drinking</span><span class="field-value">{% if m.drinking_changed %}Changed: {{ m.drinking_direction }}{% else %}Normal{% endif %}</span></div>
                    <div class="field"><span class="field-label">Stool</span><span class="field-value">{% if m.stool_quality_changed %}Changed{% if m.stool_colour %}, colour: {{ m.stool_colour }}{% endif %}{% if m.poops_per_day %}, {{ m.poops_per_day }}/day{% endif %}{% if m.stool_types %}, types: {{ m.stool_types|pretty_csv }}{% endif %}{% else %}Normal{% endif %}</span></div>
                    <div class="field"><span class="field-label">Medication Admin</span><span class="field-value">{{ m.medication_admin_method|pretty_med_admin }}</span></div>
                    {% else %}<p class="empty-msg">No medical data</p>{% endif %}
                    {% endwith %}
                    {% if pet.adverse_reactions.exists %}
                    <div class="sub-head warn">Adverse Reactions</div>
                    <div class="table-wrap"><table>
                        <thead><tr><th>Brand</th><th>Product</th><th>Form</th><th>Since</th><th>Symptoms</th></tr></thead>
                        <tbody>{% for ar in pet.adverse_reactions.all %}<tr><td>{{ ar.brand }}</td><td>{{ ar.product_ingredient_medication }}</td><td>{{ ar.form_type }}</td><td>{{ ar.fed_since }}</td><td>{{ ar.reaction_symptoms }}</td></tr>{% endfor %}</tbody>
                    </table></div>
                    {% endif %}
                    {% with c=pet.chronic_condition %}
                    {% if c %}<div class="field" style="margin-top:12px"><span class="field-label">Chronic Conditions</span><span class="field-value">{% if c.has_chronic %}Yes — {{ c.details }}{% else %}None{% endif %}</span></div>{% endif %}
                    {% endwith %}
                </div>
            </div>

            <!-- 8. Vaccination -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>8. Vaccination &amp; Vet Info</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% with v=pet.vaccination_status %}
                    {% if v %}
                    <div class="field"><span class="field-label">Yearly Vaccinations</span><span class="field-value">{% if v.yearly_vaccinations %}Yes{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Deworming</span><span class="field-value">{% if v.deworming %}Yes{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Topical Tick/Flea</span><span class="field-value">{{ v.topical_tick_flea|pretty_token }}</span></div>
                    <div class="field"><span class="field-label">Oral Tick/Flea</span><span class="field-value">{{ v.oral_tick_flea|pretty_token }}</span></div>
                    {% else %}<p class="empty-msg">No vaccination data</p>{% endif %}
                    {% endwith %}
                    {% with pv=primary_vet %}
                    {% if pv %}
                    <div class="sub-head">Primary Vet</div>
                    <div class="field"><span class="field-label">Vet Name</span><span class="field-value">{{ pv.vet_name }}</span></div>
                    <div class="field"><span class="field-label">Practice</span><span class="field-value">{{ pv.practice_name_location }}</span></div>
                    <div class="field"><span class="field-label">Phone</span><span class="field-value">{{ pv.clinic_phone }}</span></div>
                    <div class="field"><span class="field-label">Email</span><span class="field-value">{{ pv.email }}</span></div>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>

            <!-- 9. Consent -->
            <div class="cd-section">
                <div class="cd-section-head" onclick="this.parentElement.classList.toggle('open')">
                    <span>9. Consent</span>
                    <svg class="cd-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="cd-section-body">
                    {% with c=pet.owner.consent %}
                    {% if c %}
                    <div class="field"><span class="field-label">Agreed</span><span class="field-value">{% if c.agreed %}Yes{% else %}No{% endif %}</span></div>
                    <div class="field"><span class="field-label">Date Signed</span><span class="field-value">{{ c.date_signed|date:"d M Y H:i" }}</span></div>
                    {% else %}<p class="empty-msg">No consent data</p>{% endif %}
                    {% endwith %}
                </div>
            </div>

        </div>
    </main>
</div>
</body>
</html>
